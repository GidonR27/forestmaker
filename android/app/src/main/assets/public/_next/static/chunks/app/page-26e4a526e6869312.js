(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{3844:function(e,t,i){Promise.resolve().then(i.bind(i,3037))},3037:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return y}});var o=i(7437),n=i(2265);let a={wind:[{id:"wind-soft",url:"/assets/audio/wind/Light_wind.mp3",intensity:"soft"},{id:"wind-moderate",url:"/assets/audio/wind/Moderate_wind.mp3",intensity:"moderate"},{id:"wind-strong",url:"/assets/audio/wind/Strong_wind.mp3",intensity:"strong"}],rain:[{id:"rain-soft",url:"/assets/audio/rain/Light_rain.mp3",intensity:"soft"},{id:"rain-moderate",url:"/assets/audio/rain/Moderate_rain.mp3",intensity:"moderate"},{id:"rain-strong",url:"/assets/audio/rain/Strong_rain.mp3",intensity:"strong"}],birds:[{id:"birds-soft",url:"/assets/audio/birds/Light_birds.mp3",intensity:"soft"},{id:"birds-moderate",url:"/assets/audio/birds/Moderate_birds.mp3",intensity:"moderate"},{id:"birds-strong",url:"/assets/audio/birds/Strong_birds.mp3",intensity:"strong"}],thunder:[{id:"thunder-soft",url:"/assets/audio/thunder/Light_thunder.mp3",intensity:"soft"},{id:"thunder-moderate",url:"/assets/audio/thunder/Moderate_thunder.mp3",intensity:"moderate"},{id:"thunder-strong",url:"/assets/audio/thunder/Strong_thunder.mp3",intensity:"strong"}],water:[{id:"water-soft",url:"/assets/audio/water/Light_water.mp3",intensity:"soft"},{id:"water-moderate",url:"/assets/audio/water/Moderate_water.mp3",intensity:"moderate"},{id:"water-strong",url:"/assets/audio/water/Strong_water.mp3",intensity:"strong"}],insects:[{id:"insects-soft",url:"/assets/audio/insect/Light_insect.mp3",intensity:"soft"},{id:"insects-moderate",url:"/assets/audio/insect/Moderate_insect.mp3",intensity:"moderate"},{id:"insects-strong",url:"/assets/audio/insect/Strong_insect.mp3",intensity:"strong"}],mammals:[{id:"mammals-soft",url:"/assets/audio/mammals/Light_mammals.mp3",intensity:"soft"},{id:"mammals-moderate",url:"/assets/audio/mammals/Moderate_mammals.mp3",intensity:"moderate"},{id:"mammals-strong",url:"/assets/audio/mammals/Strong_mammals.mp3",intensity:"strong"}],fire:[{id:"fire-soft",url:"/assets/audio/fire/Light_fire.mp3",intensity:"soft"},{id:"fire-moderate",url:"/assets/audio/fire/Moderate_fire.mp3",intensity:"moderate"},{id:"fire-strong",url:"/assets/audio/fire/Strong_fire.mp3",intensity:"strong"}],ambient:[{id:"ambient-soft",url:"/assets/audio/ambient/Light_ambient.mp3",intensity:"soft"},{id:"ambient-moderate",url:"/assets/audio/ambient/Moderate_ambiant.mp3",intensity:"moderate"},{id:"ambient-strong",url:"/assets/audio/ambient/Strong_ambiant.mp3",intensity:"strong"}],spiritual:[{id:"spiritual-soft",url:"/assets/audio/ancient/Light_ancient.mp3",intensity:"soft"},{id:"spiritual-moderate",url:"/assets/audio/ancient/Moderate_ancient.mp3",intensity:"moderate"},{id:"spiritual-strong",url:"/assets/audio/ancient/Strong_ancient.mp3",intensity:"strong"}]};var r=i(9973),s=i(5168);let l={wind:s.W2m,rain:s.JPc,birds:s.BOY,thunder:s.vyv,water:s.TTk,insects:s.Ow4,mammals:s.X_y,fire:s.p8m,ambient:s.tem,spiritual:s.GzN},c={wind:"Wind",rain:"Rain",birds:"Birds",thunder:"Thunder",water:"Water",insects:"Insects",mammals:"Mammals",fire:"Fire",ambient:"Ambient",spiritual:"Spiritual"};function u(e){let{onSoundChange:t}=e,[i,s]=(0,n.useState)(()=>{let e={};return Object.keys(l).forEach(t=>{e[t]={value:0,isActive:!1,showSlider:!1,targetValue:0}}),e}),[u,d]=(0,n.useState)([]),[g,h]=(0,n.useState)(!1),m=(0,n.useRef)(),f=(0,n.useRef)(),p=(0,n.useRef)({}),b=(0,n.useRef)({});(0,n.useEffect)(()=>{let e=()=>{let t=!1,o={...i};Object.entries(i).forEach(e=>{let[i,n]=e;if(void 0!==n.targetValue&&n.value!==n.targetValue){let e=n.targetValue-n.value;Math.abs(e)>.001?o[i]={...n,value:n.value+.1*e}:o[i]={...n,value:n.targetValue},t=!0}}),t&&s(o),f.current=requestAnimationFrame(e)};return f.current=requestAnimationFrame(e),()=>{f.current&&cancelAnimationFrame(f.current)}},[i]),(0,n.useEffect)(()=>{m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{let e=Object.entries(i).filter(e=>{let[t,i]=e;return i.isActive&&i.value>0}).map(e=>{let[t,i]=e;return{name:t,value:i.value}});console.log("[DEBUG] All active sounds before filtering:",e.map(e=>"".concat(e.name,":").concat(e.value.toFixed(2)))),e.sort((e,t)=>t.value-e.value),console.log("[DEBUG] Sorted active sounds by value:",e.map(e=>"".concat(e.name,":").concat(e.value.toFixed(2))));let o=e.map(e=>e.name);console.log("[DEBUG] Selected sounds for visuals:",o);let n={};Object.entries(i).forEach(e=>{let[t,i]=e;n[t]=i.isActive?i.value:0}),JSON.stringify(o)!==JSON.stringify(u)&&(console.log("Updating active sounds:",{topSounds:o,currentActiveSounds:u,allSounds:i}),d(o),t(o,n))},350)},[i,u,t]),(0,n.useEffect)(()=>((async()=>{try{await r.audioManager.initialize(),Object.values(a).forEach(e=>{e.forEach(e=>{r.audioManager.loadSound({id:e.id,url:e.url})})})}catch(e){console.error("Failed to load audio assets:",e)}})(),()=>{r.audioManager.cleanup()}),[]);let y=e=>e in a,P=e=>e<=.33?"soft":e<=.66?"moderate":"strong",v=(0,n.useRef)({}),x=(0,n.useCallback)(async(e,t)=>{if(y(e))try{var o;let n=Date.now(),s=p.current[e]||{time:0},l=P(t);if(0===t){let t=Object.values(a[e]).map(e=>e.id);r.audioManager.ensureAllStopped(t),v.current[e]="";return}if(n-s.time<150&&s.intensity===l)return;let c=null===(o=a[e])||void 0===o?void 0:o.find(e=>e.intensity===l);if(!c)return;v.current[e]===c.id?(console.log("[Audio Debug] ".concat(e," already playing at ").concat(l," intensity, adjusting volume only")),r.audioManager.setVolume(c.id,.3+.7*t)):(console.log("[Audio Debug] Changing ".concat(e," from ").concat(v.current[e]," to ").concat(c.id)),Object.values(a[e]).forEach(e=>{r.audioManager.stopSound(e.id)}),p.current[e]={time:n,intensity:l},i[e].isActive&&t>0&&(await r.audioManager.playSound({id:c.id,url:c.url},.3+.7*t),v.current[e]=c.id))}catch(t){console.error("Failed to handle audio for ".concat(e,":"),t),y(e)&&(Object.values(a[e]).forEach(e=>{r.audioManager.stopSound(e.id)}),v.current[e]="")}},[y,i]),w=(0,n.useCallback)((e,t)=>{b.current[e]&&clearTimeout(b.current[e]),s(i=>({...i,[e]:{...i[e],targetValue:t,isActive:t>0,showSlider:!0}})),b.current[e]=setTimeout(()=>{x(e,t)},50)},[i,x]),D=(0,n.useCallback)(async e=>{console.log("Icon Click:",{sound:e,currentState:i[e],hasAudio:y(e)});let t=i[e].isActive?0:.5,o=!i[e].isActive;if(s(i=>({...i,[e]:{...i[e],targetValue:t,isActive:o,showSlider:!0}})),y(e))try{var n;if(!o){let t=Object.values(a[e]).map(e=>e.id);r.audioManager.ensureAllStopped(t),v.current[e]="";return}let t=null===(n=a[e])||void 0===n?void 0:n.find(e=>"soft"===e.intensity);if(t){if(v.current[e]!==t.id){let i=Object.values(a[e]).map(e=>e.id);r.audioManager.ensureAllStopped(i),await r.audioManager.playSound({id:t.id,url:t.url},.3),v.current[e]=t.id}else console.log("[Audio Debug] ".concat(e," already playing at soft intensity, not restarting"))}}catch(t){console.error("Failed to handle audio for ".concat(e,":"),t),y(e)&&(Object.values(a[e]).forEach(e=>{r.audioManager.stopSound(e.id)}),v.current[e]="")}},[i,y]);return(0,o.jsx)("div",{className:"fixed bottom-0 left-0 right-0 p-4 md:p-6 z-50",children:(0,o.jsx)("div",{className:"grid grid-cols-5 md:grid-cols-10 gap-2 md:gap-4",children:Object.entries(i).map(e=>{let[t,i]=e,n=l[t],a=i.isActive,r=y(t);return(0,o.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[(0,o.jsxs)("div",{className:"relative h-32 md:h-36 w-12 flex items-center justify-center transition-all duration-300 ".concat(i.showSlider?"opacity-100":"opacity-0 md:opacity-100"),children:[(0,o.jsx)("div",{className:"absolute inset-0 w-2 mx-auto rounded-full bg-gray-700/30"}),(0,o.jsx)("div",{className:"absolute bottom-0 w-2 mx-auto rounded-full transition-all ".concat(a?r?"bg-blue-500/50":"bg-purple-500/50":"bg-gray-500/30"),style:{height:"".concat(100*i.value,"%")}}),(0,o.jsx)("input",{type:"range",min:"0",max:"1",step:"0.01",value:i.value,onChange:e=>w(t,parseFloat(e.target.value)),className:"absolute h-full w-8 md:w-2 appearance-none bg-transparent cursor-pointer touch-manipulation",style:{WebkitAppearance:"slider-vertical"}})]}),(0,o.jsxs)("div",{className:"flex flex-col items-center gap-1 bg-black/10 backdrop-blur-md rounded-lg px-3 py-2",children:[(0,o.jsx)("button",{onClick:()=>D(t),className:"p-2 md:p-2 rounded-full transition-all transform hover:scale-110 touch-manipulation ".concat(a?r?"bg-blue-500/20 text-blue-400 hover:bg-blue-500/30":"bg-purple-500/20 text-purple-400 hover:bg-purple-500/30":"bg-gray-500/20 text-gray-400 hover:bg-gray-500/30"),"aria-label":"Toggle ".concat(c[t]),children:(0,o.jsx)(n,{className:"w-6 h-6 md:w-6 md:h-6"})}),(0,o.jsx)("span",{className:"text-[10px] md:text-xs font-medium ".concat(a?"text-white":"text-white/60"),children:c[t]})]})]},t)})})})}function d(e){let{forest:t}=e;return(0,o.jsx)("div",{className:"text-center flex flex-col justify-start",children:t?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("h2",{className:"text-2xl md:text-3xl font-bold mb-2 md:mb-3 text-white/90",children:t.name}),(0,o.jsx)("p",{className:"text-sm md:text-base text-white/70 mb-2 md:mb-3",children:t.location}),(0,o.jsx)("div",{className:"flex flex-wrap justify-center gap-1 md:gap-2",children:t.vibe.split(",").map((e,t)=>(0,o.jsx)("span",{className:"px-3 md:px-3 py-1.5 md:py-1 rounded-full text-[10px] md:text-sm font-medium bg-black/10 backdrop-blur-md text-white border border-white/20 shadow-lg shadow-black/5 touch-manipulation",children:e.trim()},t))})]}):(0,o.jsxs)("div",{className:"text-center",children:[(0,o.jsx)("h2",{className:"text-2xl md:text-3xl font-bold mb-2 md:mb-3 text-white/90",children:"Forest Maker"}),(0,o.jsx)("p",{className:"text-sm md:text-base text-white/70",children:"Adjust the sliders to create your perfect forest atmosphere"})]})})}function g(e){let{icon:t,onClick:i,variant:n="primary",size:a="md",tooltip:r,disabled:s,...l}=e,c="".concat("rounded-full flex items-center justify-center transition-colors duration-200"," ").concat({primary:"bg-green-600 hover:bg-green-700 text-white",secondary:"bg-gray-800 hover:bg-gray-700 text-white",ghost:"bg-transparent hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300"}[n]," ").concat({sm:"w-8 h-8",md:"w-10 h-10",lg:"w-12 h-12"}[a]," ").concat(s?"opacity-50 cursor-not-allowed":"cursor-pointer");return(0,o.jsx)("button",{className:c,onClick:i,disabled:s,title:r,"aria-label":r,...l,children:(0,o.jsx)(t,{size:{sm:16,md:20,lg:24}[a]})})}var h=(0,n.forwardRef)(function(e,t){let{forest:i,activeSounds:a,isVisible:l,onClose:c}=e,u=(0,n.useRef)(null),d=(0,n.useRef)(null),[h,m]=(0,n.useState)(!1),[f,p]=(0,n.useState)(!1),[b,y]=(0,n.useState)(!1),P=(0,n.useRef)(null),v=(0,n.useRef)(null),x=(0,n.useRef)(null),w=(0,n.useRef)(null),[D,S]=(0,n.useState)(!1),A=(0,n.useRef)(0),M=(0,n.useRef)(Date.now()),C=(0,n.useRef)([]),E=(0,n.useRef)(null),k=(0,n.useRef)(0),T=(0,n.useRef)("visible"),R=(0,n.useRef)(!1),F=(0,n.useRef)(!1);(0,n.useEffect)(()=>{k.current=performance.now(),"undefined"!=typeof document&&(T.current=document.visibilityState),F.current=l},[]),(0,n.useEffect)(()=>{u.current&&(u.current.setAttribute("webkit-playsinline","true"),u.current.setAttribute("x-webkit-airplay","allow"),u.current.setAttribute("webkitShowPlaybackTargetPicker","true"),u.current.setAttribute("airplay","allow"),u.current.setAttribute("controlsList","nodownload"),u.current.setAttribute("disableRemotePlayback","false"),"function"==typeof u.current.showPlaybackTargetPicker&&(console.log("[PiP Debug] Device supports showPlaybackTargetPicker API"),u.current.addEventListener("webkitplaybacktargetavailabilitychanged",e=>{console.log("[PiP Debug] Playback target availability changed:",e.availability)})))},[u.current]),(0,n.useEffect)(()=>{if(l&&"undefined"!=typeof document)return E.current=setInterval(()=>{let e=document.hidden,t=C.current.length>0?C.current.reduce((e,t)=>e+t,0)/C.current.length:0;console.log("[PiP Debug] Stats:",{isPiPActive:h,isPlaying:D,isDocumentHidden:e,frameCount:A.current,avgFrameRate:t.toFixed(2),activeSoundCount:a.size,documentVisibilityState:document.visibilityState,videoState:u.current?{paused:u.current.paused,currentTime:u.current.currentTime,readyState:u.current.readyState,networkState:u.current.networkState}:"not available"}),C.current=[]},3e3),()=>{E.current&&clearInterval(E.current)}},[l,h,D,a]),(0,n.useEffect)(()=>{if("undefined"==typeof document)return;let e=()=>{console.log("[PiP Debug] Visibility changed: ".concat(document.visibilityState,", previous: ").concat(T.current)),"visible"===document.visibilityState&&"hidden"===T.current&&(console.log("[PiP Debug] Returning from background"),h&&(console.log("[PiP Debug] Setting pending foreground transition flag"),R.current=!0,setTimeout(()=>{R.current=!1},5e3))),"hidden"===document.visibilityState&&u.current&&(console.log("[PiP Debug] Document hidden - checking video state"),console.log("[PiP Debug] Video paused: ".concat(u.current.paused))),T.current=document.visibilityState};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}},[h]),(0,n.useEffect)(()=>{if("undefined"==typeof navigator||"undefined"==typeof document)return;let e=/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1;y(e);let t="function"==typeof document.createElement("video").requestPictureInPicture,i=document.pictureInPictureEnabled,o=e&&/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent),n=o||t&&i;p(n),console.log("[PiP Debug] Device detection:",{isIOS:e,isIOSSafari:o,hasPiPAPI:t,hasPiPEnabled:i,supportsPiP:n})},[]),(0,n.useEffect)(()=>{if(!d.current||!l)return;let e=d.current,t=e.getContext("2d");return t?(e.width=640,e.height=360,(()=>{if(!i)return;let o=new Image;w.current=o,o.crossOrigin="anonymous",o.src=i.imageUrl,o.onload=()=>{console.log("[PiP Debug] Forest image loaded: ".concat(i.name));let n=()=>{let a,r,s,l;if(!t||!o)return;let c=Date.now(),u=c-M.current;if(C.current.push(u>0?1e3/u:0),M.current=c,t.clearRect(0,0,e.width,e.height),o.width/o.height>e.width/e.height?(r=e.height,a=o.width*(e.height/o.height),s=(e.width-a)/2,l=0):(a=e.width,r=o.height*(e.width/o.width),s=0,l=(e.height-r)/2),t.drawImage(o,s,l,a,r),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,e.height-40,e.width,40),t.font="20px Arial",t.fillStyle="white",t.textAlign="center",t.fillText(i.name,e.width/2,e.height-15),A.current=(A.current+1)%1e3,t.fillStyle="rgba(0, 0, 0, 0.01)",t.fillRect(0,0,1,1),t.fillStyle="rgba(255, 255, 255, 0.01)",t.fillRect(A.current%e.width,0,1,1),A.current%10==0){let i=new Date().toISOString().substring(11,23);t.fillStyle="rgba(255, 255, 255, 0.03)",t.font="10px monospace",t.textAlign="right",t.fillText("f:".concat(A.current," t:").concat(i),e.width-10,10)}v.current=requestAnimationFrame(n)};v.current&&cancelAnimationFrame(v.current),v.current=requestAnimationFrame(n),x.current&&clearInterval(x.current),x.current=setInterval(()=>{if(t&&o){let e=.01+.005*Math.sin(Date.now()/1e3);t.fillStyle="rgba(0, 0, 0, ".concat(e,")"),t.fillRect(0,0,1,1),"hidden"===document.visibilityState&&console.log("[PiP Debug] Keepalive tick at ".concat(new Date().toISOString().substring(11,23)))}},1e3/30)}})(),()=>{console.log("[PiP Debug] Cleaning up canvas animation"),v.current&&cancelAnimationFrame(v.current),x.current&&clearInterval(x.current)}):void 0},[i,l]);let G=()=>{console.log("[PiP Debug] Custom miniplayer closed - cleaning up audio"),m(!1),r.audioManager&&("function"==typeof r.audioManager.clearPiPConnections?(console.log("[PiP Debug] Running full clearPiPConnections for custom close"),r.audioManager.clearPiPConnections()):(console.log("[PiP Debug] Running fallback audio cleanup for custom close"),r.audioManager.connectToPiP=void 0,r.audioManager.setMainPageMasterGain&&r.audioManager.setMainPageMasterGain(null)),r.audioManager.audioContext&&r.audioManager.audioContext.resume().catch(e=>{console.error("[PiP Debug] Error resuming audio in cleanup:",e)})),P.current&&(console.log("[PiP Debug] Stopping all tracks in custom close"),P.current.getTracks().forEach(e=>{e.stop()}))};(0,n.useImperativeHandle)(t,()=>({cleanupAudio:()=>{console.log("[PiP Debug] Parent component triggered audio cleanup"),G()}})),(0,n.useEffect)(()=>(F.current&&!l&&(console.log("[PiP Debug] Visibility changing from visible to not visible"),h?(console.log("[PiP Debug] PiP was active during visibility change - running cleanup"),G()):r.audioManager.connectToPiP&&(console.log("[PiP Debug] Audio connections exist - ensuring cleanup on visibility change"),G())),F.current=l,()=>{(h||r.audioManager.connectToPiP)&&(console.log("[PiP Debug] Component unmounting - running thorough cleanup"),G())}),[l,h]),(0,n.useEffect)(()=>{if(d.current&&l)return(async()=>{try{let e,t;console.log("[PiP Debug] Setting up media stream"),P.current&&(P.current.getTracks().forEach(e=>e.stop()),S(!1));let i=d.current;if(!i)return;let o=i.captureStream(30);console.log("[PiP Debug] Canvas stream created:",{videoTracks:o.getVideoTracks().length,audioTracks:o.getAudioTracks().length}),r.audioManager.audioContext||(await r.audioManager.initialize(),console.log("[PiP Debug] Audio context initialized"));let n=r.audioManager.audioContext;if(!n)throw Error("Audio context not available");try{e=n.createMediaStreamDestination(),console.log("[PiP Debug] Audio destination created")}catch(e){throw console.error("[PiP Debug] Failed to create audio destination:",e),Error("Could not create audio destination")}r.audioManager.connectToPiP=t=>{try{if(t.context!==n){console.error("[PiP Debug] Cannot connect - source and destination contexts differ");return}t.connect(e),console.log("[PiP Debug] Audio source connected to PiP")}catch(e){console.error("[PiP Debug] Error connecting audio source to PiP:",e)}};try{r.audioManager.connectAllToPiP(),console.log("[PiP Debug] All active audio sources connected to PiP")}catch(e){console.error("[PiP Debug] Error connecting audio sources to PiP:",e)}let a=e.stream.getAudioTracks();if(console.log("[PiP Debug] Initial audio tracks:",a.length),0===a.length){console.log("[PiP Debug] No audio tracks, creating silent audio track");try{let t=n.createOscillator(),i=n.createGain();i.gain.value=.01,t.connect(i),i.connect(e),t.start(),await new Promise(e=>setTimeout(e,100)),a=e.stream.getAudioTracks(),console.log("[PiP Debug] After adding silent track, audio tracks:",a.length)}catch(e){console.error("[PiP Debug] Failed to create silent audio track:",e)}}a.forEach((e,t)=>{console.log("[PiP Debug] Audio track ".concat(t," enabled:"),e.enabled);let i=setInterval(()=>{"hidden"===document.visibilityState&&h&&console.log("[PiP Debug] Audio track ".concat(t," status: enabled=").concat(e.enabled,", readyState=").concat(e.readyState,", muted=").concat(e.muted))},2e3);e.addEventListener("ended",()=>{console.log("[PiP Debug] Audio track ".concat(t," ended")),clearInterval(i)})});try{t=new MediaStream([...o.getVideoTracks(),...a]),console.log("[PiP Debug] Combined stream created:",{videoTracks:t.getVideoTracks().length,audioTracks:t.getAudioTracks().length})}catch(e){console.error("[PiP Debug] Failed to create combined stream:",e),t=new MediaStream([...o.getVideoTracks()]),console.log("[PiP Debug] Fallback to video-only stream")}if(P.current=t,u.current){u.current.srcObject=t;try{let e=u.current.play();void 0!==e&&e.then(()=>{var e,t,i;console.log("[PiP Debug] Video playback started successfully"),S(!0),null===(e=u.current)||void 0===e||e.addEventListener("pause",()=>{console.log("[PiP Debug] Video paused event")}),null===(t=u.current)||void 0===t||t.addEventListener("play",()=>{console.log("[PiP Debug] Video play event")}),null===(i=u.current)||void 0===i||i.addEventListener("stalled",()=>{console.log("[PiP Debug] Video stalled event")})}).catch(e=>{console.error("[PiP Debug] Video playback failed:",e),S(!1)})}catch(e){console.error("[PiP Debug] Error auto-playing video:",e)}}}catch(e){console.error("[PiP Debug] Failed to setup PiP stream:",e),r.audioManager.connectToPiP&&(console.log("[PiP Debug] Clearing failed PiP connections for recovery"),r.audioManager.connectToPiP=void 0,"function"==typeof r.audioManager.clearPiPConnections&&r.audioManager.clearPiPConnections())}})(),()=>{console.log("[PiP Debug] Cleaning up audio/video stream"),P.current&&P.current.getTracks().forEach(e=>{console.log("[PiP Debug] Stopping track: ".concat(e.kind)),e.stop()}),h?(console.log("[PiP Debug] Stream cleanup while PiP was active - running full cleanup"),G()):(console.log("[PiP Debug] Removing connectToPiP method"),r.audioManager.connectToPiP&&(r.audioManager.connectToPiP=void 0))}},[l,a,h]),(0,n.useEffect)(()=>{if(!h||"undefined"==typeof document||"undefined"==typeof performance)return;console.log("[PiP Debug] Setting up PiP heartbeat monitor");let e=setInterval(()=>{if(u.current&&u.current.paused&&(console.log("[PiP Debug] PiP video paused, attempting to restart"),u.current.play().catch(e=>{console.error("[PiP Debug] Failed to restart video in PiP heartbeat:",e)})),d.current){let e=d.current.getContext("2d");e&&(e.fillStyle="rgba(0, 0, 0, 0.01)",e.fillRect(5*Math.random(),5*Math.random(),1,1),"hidden"===document.visibilityState&&console.log("[PiP Debug] PiP heartbeat tick while page hidden"))}if(r.audioManager.audioContext){let e=r.audioManager.audioContext.state;console.log("[PiP Debug] Audio context state: ".concat(e)),("suspended"===e||"interrupted"===e)&&(console.log("[PiP Debug] Audio context not running, using PiP audio recovery"),"function"==typeof r.audioManager.recoverPiPAudio?r.audioManager.recoverPiPAudio():r.audioManager.audioContext.resume().catch(e=>{console.error("[PiP Debug] Failed to resume audio context:",e)}))}console.log("[PiP Debug] Stats:",{isPiPActive:h,isPlaying:D,isDocumentHidden:"hidden"===document.visibilityState,frameCount:A.current,avgFrameRate:(A.current/(performance.now()-k.current)*1e3).toFixed(2),activeSoundCount:a.size,documentVisibilityState:document.visibilityState,videoState:u.current?{paused:u.current.paused,currentTime:u.current.currentTime,readyState:u.current.readyState,networkState:u.current.networkState}:"no video"})},1e3);return()=>{console.log("[PiP Debug] Cleaning up PiP heartbeat"),clearInterval(e)}},[h,D,a]),(0,n.useEffect)(()=>{if(!h||!b||"undefined"==typeof document)return;console.log("[PiP Debug] Setting up iOS background audio keepalive");let e=null,t=null;(async()=>{r.audioManager.audioContext||await r.audioManager.initialize();let i=r.audioManager.audioContext;i&&(e=i.createOscillator(),(t=i.createGain()).gain.value=.001,e.frequency.value=40,e.connect(t),t.connect(i.destination),e.start(),console.log("[PiP Debug] Silent keepalive audio started"))})();let i=setInterval(()=>{if("hidden"===document.visibilityState&&r.audioManager.audioContext&&t){let e=.001+5e-4*Math.random();t.gain.value=e,console.log("[PiP Debug] Audio keepalive ping: ".concat(e.toFixed(5)))}},2e3);return()=>{if(clearInterval(i),e)try{e.stop(),e.disconnect(),console.log("[PiP Debug] Silent keepalive audio stopped")}catch(e){console.error("[PiP Debug] Error stopping silent audio:",e)}t&&t.disconnect()}},[h,b]),(0,n.useEffect)(()=>{if(!u.current||!h)return;console.log("[PiP Debug] Setting up PiP play event handler");let e=()=>{if(console.log("[PiP Debug] PiP video play event detected"),r.audioManager.audioContext){let e=r.audioManager.audioContext.state;console.log("[PiP Debug] Audio context state on play: ".concat(e)),"running"!==e&&(console.log("[PiP Debug] Activating audio on PiP play event"),"function"==typeof r.audioManager.recoverPiPAudio?r.audioManager.recoverPiPAudio():r.audioManager.audioContext.resume().catch(e=>{console.error("[PiP Debug] Failed to resume audio on play:",e)}),setTimeout(()=>{"function"==typeof r.audioManager.reconnectAllSounds&&(console.log("[PiP Debug] Reconnecting sounds after play event"),r.audioManager.reconnectAllSounds())},500))}},t=()=>{console.log("[PiP Debug] PiP video pause event detected"),u.current&&u.current.paused&&h&&(console.log('[PiP Debug] Video paused but PiP still active - likely "Play in background" button'),setTimeout(()=>{var e;"visible"===document.visibilityState&&(null===(e=u.current)||void 0===e?void 0:e.paused)&&h&&(console.log("[PiP Debug] Detected iOS background playback mode, ensuring main page audio is active"),console.log("[PiP Debug] Running full audio cleanup for background playback mode"),G(),c&&(console.log('[PiP Debug] Notifying parent of "Play in background" close'),c()))},300))};return u.current.addEventListener("play",e),u.current.addEventListener("pause",t),()=>{var i,o;null===(i=u.current)||void 0===i||i.removeEventListener("play",e),null===(o=u.current)||void 0===o||o.removeEventListener("pause",t)}},[h]),(0,n.useEffect)(()=>(h?(console.log("[PiP Debug] Setting up audio connection for PiP"),(async()=>{try{if(r.audioManager.audioContext||await r.audioManager.initialize(),!r.audioManager.audioContext){console.error("[PiP Debug] Failed to initialize audio context");return}let e=r.audioManager.audioContext.createMediaStreamDestination();r.audioManager.connectToPiP=t=>{try{t.connect(e),console.log("[PiP Debug] Successfully connected audio source to PiP")}catch(e){console.error("[PiP Debug] Error connecting audio to PiP:",e)}};let t=r.audioManager.audioContext.createGain();if(t.gain.value=0,t.connect(r.audioManager.audioContext.destination),r.audioManager.setMainPageMasterGain(t),P.current)try{P.current.addTrack(e.stream.getAudioTracks()[0]),console.log("[PiP Debug] Added audio track to stream")}catch(e){console.error("[PiP Debug] Error adding audio track to stream:",e)}}catch(e){console.error("[PiP Debug] Error setting up PiP audio:",e)}})()):(r.audioManager.connectToPiP&&(console.log("[PiP Debug] Clearing audio PiP connection"),r.audioManager.connectToPiP=void 0,R.current&&(console.log("[PiP Debug] Detected foreground transition - handling audio cleanup"),R.current=!1,setTimeout(()=>{console.log("[PiP Debug] Running dedup cleanup after foreground transition"),r.audioManager.dedupAllSounds()},300))),r.audioManager.setMainPageMasterGain(null)),()=>{h||(r.audioManager.connectToPiP=void 0,r.audioManager.setMainPageMasterGain(null))}),[h]);let U=async()=>{try{if(!u.current)return;if(console.log("[PiP Debug] Entering PiP mode"),u.current.focus(),!D)try{console.log("[PiP Debug] Video not playing, attempting to play"),await u.current.play(),S(!0)}catch(e){console.error("[PiP Debug] Failed to play video before PiP:",e),alert("Please tap on the video to start playback then try again. Audio playback requires user interaction on your device.");return}if(b){if(console.log("[PiP Debug] Using iOS-specific PiP API"),u.current.webkitSupportsPresentationMode&&"function"==typeof u.current.webkitSetPresentationMode){u.current.webkitSetPresentationMode("picture-in-picture"),m(!0);let e=setInterval(()=>{u.current?"picture-in-picture"!==u.current.webkitPresentationMode&&h&&(console.log("[PiP Debug] iOS PiP mode exited"),m(!1),clearInterval(e),console.log("[PiP Debug] Running unified cleanup after iOS PiP exit"),G(),c&&(console.log("[PiP Debug] Notifying parent of iOS system PiP close"),c())):clearInterval(e)},500)}else throw Error("iOS PiP not supported in this browser")}else console.log("[PiP Debug] Using standard PiP API"),await u.current.requestPictureInPicture(),m(!0),u.current.addEventListener("leavepictureinpicture",()=>{console.log("[PiP Debug] Left PiP mode (standard API)"),m(!1),console.log("[PiP Debug] Running unified cleanup after standard PiP exit"),G(),c&&(console.log("[PiP Debug] Notifying parent of standard PiP close"),c())});console.log("[PiP Debug] Successfully entered PiP mode")}catch(e){console.error("[PiP Debug] Failed to enter PiP mode:",e),alert("Failed to enter Picture-in-Picture mode. This may not be supported in your browser.")}};return l?(0,o.jsx)("div",{className:"fixed top-16 right-4 z-[100]",children:(0,o.jsxs)("div",{className:"bg-black rounded-lg overflow-hidden shadow-xl w-64",children:[(0,o.jsxs)("div",{className:"relative w-full aspect-video",children:[(0,o.jsx)("canvas",{ref:d,className:"absolute inset-0 w-full h-full",style:{display:"none"}}),(0,o.jsx)("video",{ref:u,className:"w-full h-full",autoPlay:!0,playsInline:!0,controls:!0,loop:!0,muted:!1,onClick:()=>{var e;return null===(e=u.current)||void 0===e?void 0:e.play()}}),!D&&(0,o.jsx)("div",{className:"absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center",children:(0,o.jsx)("p",{className:"text-white text-center p-4",children:"Tap to start playback"})})]}),(0,o.jsxs)("div",{className:"p-2 flex justify-between items-center bg-gray-800",children:[(0,o.jsx)("span",{className:"text-white text-sm truncate",children:(null==i?void 0:i.name)||"Select a forest"}),(0,o.jsxs)("div",{className:"flex space-x-2",children:[b&&(0,o.jsxs)("span",{className:"text-white text-xs flex items-center",children:[(0,o.jsx)(s.QBi,{className:"mr-1",size:16}),"iOS"]}),(0,o.jsx)(g,{icon:s.S4f,onClick:()=>{if(u.current){console.log("[PiP Debug] Attempting to show AirPlay picker");try{"function"==typeof u.current.webkitShowPlaybackTargetPicker?(console.log("[PiP Debug] Using webkitShowPlaybackTargetPicker API"),u.current.webkitShowPlaybackTargetPicker()):"function"==typeof u.current.showPlaybackTargetPicker?(console.log("[PiP Debug] Using showPlaybackTargetPicker API"),u.current.showPlaybackTargetPicker()):(console.log("[PiP Debug] AirPlay API not available directly"),u.current.play().catch(e=>{console.error("[PiP Debug] Failed to play video for AirPlay:",e)}))}catch(e){console.error("[PiP Debug] Error showing AirPlay picker:",e)}}},variant:"secondary",size:"sm",tooltip:"AirPlay/Cast to TV"}),(0,o.jsx)(g,{icon:s.acF,onClick:U,variant:"secondary",size:"sm",tooltip:f?"Open Picture-in-Picture":"PiP not supported",disabled:h||!f})]})]}),(0,o.jsx)("button",{className:"absolute top-1 right-1 bg-black bg-opacity-50 text-white rounded-full p-1",onClick:()=>{console.log("[PiP Debug] Custom close button clicked"),G(),c&&c()},"aria-label":"Close mini player",children:(0,o.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:(0,o.jsx)("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]})}):null});function m(e){let{activeSounds:t,soundValues:i}=e,a=(0,n.useRef)(null),r=(0,n.useRef)(null),s=(0,n.useRef)(Date.now());(0,n.useRef)(new Set);let l=(0,n.useRef)(0),c=(0,n.useRef)(100),u=(0,n.useRef)(null),d=(0,n.useRef)(null),g=(0,n.useRef)(0),h=(0,n.useRef)(new Set),m=(0,n.useRef)({}),f=(0,n.useRef)(0),p=(0,n.useRef)(!1),[b,y]=(0,n.useState)({windParticles:[],raindrops:[],ripples:[],birds:[],fireflies:[],rustles:[],embers:[],ambientWaves:[],pulseRings:[],lightSpots:[],lightningBolts:[],localFlashes:[],animalShadows:[],eyePairs:[],activeEyePositions:[],lastEyePositionChange:0,eyeFadeTimestamp:0,thunderFlashLeft:!1,thunderZigzag:[],activationTimestamps:{},visualPriorities:[],fireLastRendered:!1,nextEyeReturnDelay:0}),[P,v]=(0,n.useState)({nextThunder:Date.now(),nextWaterRipple:Date.now(),nextRustle:Date.now(),nextPulseRing:Date.now(),nextMammalEyes:Date.now()}),[x,w]=(0,n.useState)(0),D=(e,t)=>Math.random()*(t-e)+e;return(0,n.useEffect)(()=>{var e;if(r.current){console.log("[DEBUG] Animation already running, only updating active sounds"),h.current=new Set(t),Object.keys(i).forEach(e=>{m.current[e]=i[e]});return}if(!a.current)return;console.log("[DEBUG] Starting animation loop");let o=a.current,n=o.getContext("2d",{alpha:!0});if(!n)return;let b=!1,P=!1,x=[];0===f.current&&(null===(e=u.current)||void 0===e?void 0:e.lastEyePositionChange)&&(console.log("[DEBUG] Preserving eye position time ref from previous animation session"),f.current=Date.now()-3e4);let S=(e,i)=>{if(console.log("[DEBUG] Initializing particles - Canvas display size: ".concat(e,"x").concat(i,", DPR: ").concat(window.devicePixelRatio||1)),e<200||i<200)return console.log("[DEBUG] Canvas too small for initialization: ".concat(e,"x").concat(i,", will try again later")),!1;let o=u.current,n=!!o,a=n?Array.from(h.current).filter(e=>t.has(e)):[];n&&a.length>0&&console.log("[DEBUG] Preserving visuals for: ".concat(a.join(", ")));let r={windParticles:n&&a.includes("wind")?o.windParticles.map(e=>({...e})):Array.from({length:50},()=>({x:Math.random()*e,y:Math.random()*i*.7,speed:.4+.5*Math.random(),radius:1.5+3*Math.random()})),raindrops:n&&a.includes("rain")?o.raindrops.map(e=>({...e})):Array.from({length:100},()=>({x:Math.random()*e,y:Math.random()*i,speed:1.5+1.5*Math.random(),length:15+15*Math.random()})),ripples:n&&a.includes("water")?o.ripples.map(e=>({...e})):[],birds:n&&a.includes("birds")?o.birds.map(e=>({...e})):Array.from({length:8},()=>({x:D(-50,e),y:D(0,.3*i),dx:.8+.7*Math.random(),dy:D(-.3,.3)})),fireflies:n&&a.includes("insects")?o.fireflies.map(e=>({...e})):Array.from({length:25},()=>({x:D(0,e),y:D(.4*i,.8*i),alpha:0,timer:7e3*Math.random(),pulseInterval:D(2e3,5e3)})),rustles:[{x:50,y:D(.2*i,.5*i),timer:0,nextAt:D(5e3,1e4),active:!1},{x:e-100,y:D(.3*i,.5*i),timer:0,nextAt:D(5e3,1e4),active:!1},{x:e/2-150,y:D(.2*i,.4*i),timer:0,nextAt:D(5e3,1e4),active:!1},{x:e/2+100,y:D(.25*i,.45*i),timer:0,nextAt:D(5e3,1e4),active:!1},{x:e/3,y:D(.2*i,.4*i),timer:0,nextAt:D(5e3,1e4),active:!1}],embers:Array.from({length:25},()=>({x:e/2+D(-50,50),y:i-50+20*Math.random(),speed:.5+.8*Math.random(),size:2+3*Math.random(),color:"rgba(".concat(255,", ").concat(150+Math.floor(105*Math.random()),", ").concat(50+Math.floor(50*Math.random()),", ").concat(.5+.5*Math.random(),")")})),ambientWaves:Array.from({length:5},(e,t)=>({x:0,y:.5*i+(t-2)*30,amplitude:10+10*Math.random(),speed:.03+.02*Math.random(),offset:Math.random()*Math.PI*2})),pulseRings:[],lightSpots:Array.from({length:20},()=>({x:D(.25*e,.75*e),y:D(.45*i,.85*i),size:D(2,9),speed:D(.05,.4),alpha:D(.2,.4)})),lightningBolts:[],localFlashes:[],animalShadows:[{x:.3*e,y:.75*i,width:D(80,140),height:D(25,45),opacity:.1,velocityX:D(-.2,.2),active:!0,glimpseTimer:1e3,glimpseType:"eyes"},{x:.6*e,y:.8*i,width:D(80,140),height:D(25,45),opacity:.1,velocityX:D(-.2,.2),active:!0,glimpseTimer:1500,glimpseType:"silhouette"},{x:.8*e,y:.7*i,width:D(80,140),height:D(25,45),opacity:.1,velocityX:D(-.2,.2),active:!0,glimpseTimer:500,glimpseType:"movement"}],eyePairs:[],activeEyePositions:[],lastEyePositionChange:0,eyeFadeTimestamp:0,thunderFlashLeft:!1,thunderZigzag:[],activationTimestamps:{},visualPriorities:[],fireLastRendered:!1,nextEyeReturnDelay:0};return y(r),u.current=r,v({nextThunder:Date.now()+1e3,nextWaterRipple:Date.now()+D(2e3,4e3),nextRustle:Date.now()+D(5e3,1e4),nextPulseRing:Date.now()+D(4e3,8e3),nextMammalEyes:Date.now()}),console.log("[DEBUG] Particles initialized successfully with dimensions ".concat(e,"x").concat(i)),!0},A=()=>{var e,t,i;let a=window.devicePixelRatio||1;console.log("[DEBUG] Device pixel ratio: ".concat(a));let r=null===(e=o.parentElement)||void 0===e?void 0:e.getBoundingClientRect();if(r){o.style.width="".concat(r.width,"px"),o.style.height="".concat(r.height,"px"),o.width=Math.floor(r.width*a),o.height=Math.floor(r.height*a),console.log("[DEBUG] Canvas size set to ".concat(o.width,"x").concat(o.height," (display: ").concat(r.width,"x").concat(r.height,", DPR: ").concat(a,")")),n.scale(a,a);let e=r.width,s=r.height;if(b){if(u.current){if(u.current.activeEyePositions&&u.current.activeEyePositions.length>0){let t=u.current.activeEyePositions.map(t=>{if(x.length>0&&P){let i=x.find((e,i)=>i===u.current.activeEyePositions.indexOf(t));if(i)return{x:i.x*(e/(e||1)),y:i.y*(s/(s||1))}}return{x:t.x*(e/(e||1)),y:t.y*(s/(s||1))}});y(e=>({...e,activeEyePositions:t})),console.log("[DEBUG] Updated eye positions after resize: ".concat(t.length," positions (maintained existing positions)"))}let o=u.current.animalShadows.map(t=>({...t,x:t.x/(e||1)*e,y:t.y/(s||1)*s}));if(y(e=>({...e,animalShadows:o})),Math.abs(e-((null===(t=u.current.windParticles[0])||void 0===t?void 0:t.x)||0))>.5*e||Math.abs(s-((null===(i=u.current.fireflies[0])||void 0===i?void 0:i.y)||0))>.5*s){console.log("[DEBUG] Canvas size changed significantly, reinitializing all particles");let t={activeEyePositions:[...u.current.activeEyePositions||[]],eyePairs:[...u.current.eyePairs||[]],lastEyePositionChange:u.current.lastEyePositionChange,eyeFadeTimestamp:u.current.eyeFadeTimestamp,nextEyeReturnDelay:u.current.nextEyeReturnDelay};S(e,s)&&P&&t.activeEyePositions.length>0&&(console.log("[DEBUG] Restoring mammal eye state after reinitialization"),y(e=>({...e,activeEyePositions:t.activeEyePositions,eyePairs:t.eyePairs,lastEyePositionChange:t.lastEyePositionChange,eyeFadeTimestamp:t.eyeFadeTimestamp,nextEyeReturnDelay:t.nextEyeReturnDelay})))}console.log("[DEBUG] Updated particle positions after resize")}}else b=S(e,s)}else o.style.width="".concat(window.innerWidth,"px"),o.style.height="".concat(window.innerHeight,"px"),o.width=Math.floor(window.innerWidth*a),o.height=Math.floor(window.innerHeight*a),console.log("[DEBUG] Canvas fallback size: ".concat(o.width,"x").concat(o.height," (window: ").concat(window.innerWidth,"x").concat(window.innerHeight,", DPR: ").concat(a,")")),n.scale(a,a),b||(b=S(window.innerWidth,window.innerHeight))};A();let M=[100,500,1e3,2e3,3e3,5e3];M.forEach((e,t)=>{setTimeout(()=>{var i,n;console.log("[DEBUG] Delayed resize #".concat(t+1," after ").concat(e,"ms"));let a={hasMammalEyesInitialized:P,initialEyePositions:[...x],eyeFadeTimestamp:(null===(i=u.current)||void 0===i?void 0:i.eyeFadeTimestamp)||0};if(A(),P=a.hasMammalEyesInitialized,x=[...a.initialEyePositions],!b&&t===M.length-1){console.log("[DEBUG] Forcing particle initialization after all resize attempts");let e=null===(n=o.parentElement)||void 0===n?void 0:n.getBoundingClientRect();b=e&&e.width>200&&e.height>200?S(e.width,e.height):S(window.innerWidth,window.innerHeight)}},e)});let C=null,E=()=>{C&&window.clearTimeout(C),C=window.setTimeout(()=>{console.log("[DEBUG] Window resized - updating canvas"),A()},100)};window.addEventListener("resize",E);let k=()=>{var e,t;let i=Date.now(),a=i-s.current;s.current=i;let A=Math.min(a,33)/16,M=window.devicePixelRatio||1,C=o.width/M,E=o.height/M;n.clearRect(0,0,C,E),l.current++,l.current%c.current==0&&(console.log("[DEBUG] Frame #".concat(l.current,", dt: ").concat(A.toFixed(2),"ms, canvas: ").concat(C,"x").concat(E)),!b&&C>200&&E>200&&(console.log("[DEBUG] Late initialization of particles in animation frame"),b=S(C,E)));let T=h.current,R=m.current;l.current;let F=u.current,G=d.current;if(T.has("wind")&&R.wind>0){let t=R.wind;if(l.current%100==0&&console.log("[DEBUG] Wind effect active: intensity=".concat(t.toFixed(2),", particles=").concat((null===(e=F.windParticles)||void 0===e?void 0:e.length)||0)),!F.windParticles||0===F.windParticles.length){console.log("[DEBUG] Wind particles missing, initializing them now");let e=Array.from({length:50},()=>({x:Math.random()*C,y:Math.random()*E*.7,speed:.4+.5*Math.random(),radius:1.5+3*Math.random()}));F.windParticles=e,y(t=>({...t,windParticles:e})),console.log("[DEBUG] Created ".concat(e.length," new wind particles"))}n.globalAlpha=Math.min(.5*t,.6),n.fillStyle="rgba(255, 255, 255, 0.8)",F.windParticles.forEach(e=>{e.x+=e.speed*t*A,e.x>C&&(e.x=0),n.beginPath(),n.arc(e.x,e.y,e.radius,0,2*Math.PI),n.fill(),n.fillStyle="rgba(255, 255, 255, 0.3)",n.beginPath(),n.arc(e.x-e.speed*t*A*2,e.y,.7*e.radius,0,2*Math.PI),n.fill()})}if(T.has("rain")&&R.rain>0){let e=R.rain;if(!F.raindrops||0===F.raindrops.length){console.log("[DEBUG] Rain particles missing, initializing them now");let e=Array.from({length:100},()=>({x:Math.random()*C,y:Math.random()*E,speed:1.5+1.5*Math.random(),length:15+15*Math.random()}));F.raindrops=e,y(t=>({...t,raindrops:e})),console.log("[DEBUG] Created ".concat(e.length," new raindrops"))}n.globalAlpha=Math.min(.6*e,.7),n.strokeStyle="rgba(220, 240, 255, 0.9)",n.lineWidth=1.5,F.raindrops.forEach(t=>{t.y+=t.speed*e*2*A,t.y>E&&(t.y=0,t.x=Math.random()*C),n.beginPath(),n.moveTo(t.x,t.y),n.lineTo(t.x,t.y+t.length),n.stroke(),t.y>E-30&&Math.random()>.9&&(n.beginPath(),n.arc(t.x,E-5,2,0,2*Math.PI),n.strokeStyle="rgba(220, 240, 255, 0.7)",n.stroke())})}if(T.has("thunder")&&R.thunder>0){let e=R.thunder;if(i>G.nextThunder&&Math.random()<.2*e){console.log("[DEBUG] Thunder triggered - Intensity: ".concat(e.toFixed(2)));let t=[],o=E/8,n=Math.random()>.5?1:-1,a=C*(.5*Math.random()-.25);for(let e=0;e<=8;e++){let i=e*o,r=.5*C+a+n*C*D(.1,.25);t.push({x:r,y:i}),n*=-1}let r=Math.random()>.5,s=Math.floor(D(5,10))*e,l=[];for(let i=0;i<s;i++){let i=Math.floor(Math.random()*t.length),o=t[i],n=r?-.1:.1,a=o.x+C*(n+D(-.1,.1)),s=o.y+D(-(.1*E),.1*E);l.push({x:a,y:s,radius:D(30,100)*e,alpha:D(.2,.6)*e,delay:D(0,200)})}w(.4*e),y(e=>({...e,thunderFlashLeft:r,thunderZigzag:t,localFlashes:[...e.localFlashes,...l]})),v(t=>({...t,nextThunder:i+D(3e3,8e3)/e}))}if(g.current>0){if(n.globalAlpha=g.current,F.thunderZigzag&&F.thunderZigzag.length>0){n.beginPath();let e=F.thunderFlashLeft,t=F.thunderZigzag;n.moveTo(e?0:C,0),n.lineTo(t[0].x,0);for(let e=0;e<t.length-1;e++){let i=(t[e].x+t[e+1].x)/2,o=(t[e].y+t[e+1].y)/2,a=C*D(-.05,.05);n.quadraticCurveTo(i+a,o,t[e+1].x,t[e+1].y)}n.lineTo(t[t.length-1].x,E),n.lineTo(e?0:C,E),n.closePath(),n.shadowColor="rgba(190, 200, 255, 0.8)",n.shadowBlur=30,n.fill(),n.shadowBlur=0}let e=Math.max(0,g.current-.01*A);Math.abs(e-g.current)>.005&&w(e)}if(F.localFlashes&&F.localFlashes.length>0){let e=F.localFlashes.filter(e=>{if(e.delay&&e.delay>0)return e.delay-=16*A,!0;n.globalAlpha=e.alpha;let t=n.createRadialGradient(e.x,e.y,0,e.x,e.y,e.radius);return t.addColorStop(0,"rgba(255, 255, 255, 0.8)"),t.addColorStop(1,"rgba(180, 200, 255, 0)"),n.fillStyle=t,n.beginPath(),n.arc(e.x,e.y,e.radius,0,2*Math.PI),n.fill(),e.alpha-=.01*A,e.alpha>0});e.length!==F.localFlashes.length&&y(t=>({...t,localFlashes:e}))}}if(T.has("water")&&R.water>0){let e=R.water;if(l.current%300==0&&console.log("[DEBUG] Water effect - intensity: ".concat(e)),F.lightSpots.map(t=>{t.x+=Math.sin(i/3e3+.01*t.y)*t.speed*A*.6,t.y+=Math.cos(i/3300+.01*t.x)*t.speed*A*.3,t.x<.2*C&&(t.x=.2*C),t.x>.8*C&&(t.x=.8*C),t.y<.4*E&&(t.y=.4*E),t.y>.9*E&&(t.y=.9*E);let o=.8+.2*Math.sin(i/2500+.5*t.x);n.globalAlpha=1.5*t.alpha*e*o;let a=Math.floor((t.x/C*3+1.5*Math.sin(i/5e3))%3),r="rgba(150, 210, 255, 0.8)",s="rgba(100, 150, 220, 0)";switch(a){case 0:r="rgba(100, 255, 255, 0.8)",s="rgba(50, 200, 210, 0)";break;case 1:r="rgba(240, 150, 255, 0.8)",s="rgba(190, 100, 210, 0)";break;case 2:r="rgba(150, 210, 255, 0.8)",s="rgba(100, 150, 220, 0)"}let l=n.createRadialGradient(t.x,t.y,0,t.x,t.y,6*t.size);return l.addColorStop(0,r),l.addColorStop(1,s),n.fillStyle=l,n.beginPath(),n.arc(t.x,t.y,6*t.size,0,2*Math.PI),n.fill(),t}),i>G.nextWaterRipple&&Math.random()<.4*e){console.log("[DEBUG] Water ripple created");let t=C*D(.25,.75),o=E*D(.5,.85),n="rgba(150, 200, 255, 0.7)";switch(Math.floor(3*Math.random())){case 0:n="rgba(100, 255, 240, 0.7)";break;case 1:n="rgba(200, 150, 255, 0.7)";break;case 2:n="rgba(150, 200, 255, 0.7)"}y(i=>({...i,ripples:[...i.ripples,{x:t,y:o,radius:5,alpha:.5*e,color:n}]})),v(t=>({...t,nextWaterRipple:i+D(2e3,5e3)/e}))}let t=F.ripples.filter(e=>(e.radius+=.3*A,e.alpha-=.002*A,!(e.alpha<=0)&&(n.globalAlpha=1.3*e.alpha,n.strokeStyle=e.color||"rgba(150, 200, 255, 0.6)",n.lineWidth=1.5,n.beginPath(),n.arc(e.x,e.y,e.radius,0,2*Math.PI),n.stroke(),!0)));t.length!==F.ripples.length&&y(e=>({...e,ripples:t}))}if(T.has("mammals")&&R.mammals>0){let e=R.mammals;l.current%100==0&&(console.log("[DEBUG] Mammal effect check - intensity: ".concat(e,", has mammals: ").concat(T.has("mammals"))),console.log("[DEBUG] Mammal shadows - frame: ".concat(l.current,", eye positions: ").concat((null===(t=F.activeEyePositions)||void 0===t?void 0:t.length)||0)));let i=e>.7;if(e>0){l.current%100==0&&console.log("[DEBUG] Mammal rendering - intensity: ".concat(e.toFixed(3),", frame: ").concat(l.current,", highDetail: ").concat(i));let t=i?3:2,o=Math.min(Math.floor(3*e)+1,t);l.current%100==0&&console.log("[DEBUG] Mammal eyes - numEyePairs: ".concat(o,", maxPairs: ").concat(t));let a=[{x:.12*C,y:.55*E},{x:.08*C,y:.7*E},{x:.25*C,y:.65*E},{x:.4*C,y:.75*E},{x:.6*C,y:.72*E},{x:.75*C,y:.6*E},{x:.92*C,y:.65*E},{x:.88*C,y:.8*E}];if(!F.lastEyePositionChange){if(console.log("[DEBUG] Initializing mammal eye positions for the first time"),P)console.log("[DEBUG] Skipping mammal eyes initialization - already initialized");else{P=!0,console.log("[DEBUG] Setting hasMammalEyesInitialized to true");let e=Math.min(2,o);console.log("[DEBUG] First mammal appearance - limiting to ".concat(e," eye pairs (was ").concat(o,")")),x=[...a].sort(()=>.5-Math.random()).slice(0,e),y(t=>({...t,lastEyePositionChange:l.current,activeEyePositions:x,eyePairs:Array(e).fill(0).map((e,t)=>({opacity:.01,blinkTimer:3e3+2e3*Math.random(),size:.64+.32*Math.random(),behavior:t%2==0?"cautious":"curious",blinkFrequency:t%2==0?"frequent":"rare",lastBlink:0})),eyeFadeTimestamp:Date.now(),nextEyeReturnDelay:0})),console.log("[DEBUG] Initial mammal eyes created with starting opacity 0.01 for proper fade-in")}}let r=l.current-(F.lastEyePositionChange||0),s=Date.now(),c=(s-(F.eyeFadeTimestamp||s))/1e3,g=c<1.5,h=c>7.5;l.current%100==0&&console.log("[DEBUG] Eyes state - fadeTime: ".concat(c.toFixed(1),"s, fading in: ").concat(g,", fading out: ").concat(h));let m=F.activeEyePositions||a.slice(0,o),b=!F.activeEyePositions||c>9.5&&s>=(G.nextMammalEyes||0);if(l.current%100==0){let e=G.nextMammalEyes?Math.max(0,(G.nextMammalEyes-s)/1e3):0;console.log("[DEBUG] Mammal eyes status - secondsSinceChange: ".concat(c.toFixed(1),"s, delay remaining: ").concat(e.toFixed(1),"s, readyForNew: ").concat(b))}if(h&&c>8.5&&c<9&&s>=(G.nextMammalEyes||0)){let e=s+D(4e3,1e4);console.log("[DEBUG] Setting mammal eye delay of ".concat(((e-s)/1e3).toFixed(1),"s during fade out")),v(t=>{let i={...t,nextMammalEyes:e};return setTimeout(()=>{d.current=i},0),i})}if(b){let e=[...a].sort(()=>.5-Math.random()),i=Math.min(Math.max(1,o),t);console.log("[DEBUG] Time for new mammal eye positions - pairs: ".concat(i,", timeSince: ").concat(r,"s, secondsSincePositionChange: ").concat(c.toFixed(1),"s"));let n=e.slice(0,i);x=[...n];let g=n.map((e,t)=>{var i;let o=null===(i=F.eyePairs)||void 0===i?void 0:i[t];return{opacity:.01,blinkTimer:3e3+2e3*Math.random(),size:.64+.32*Math.random(),behavior:(null==o?void 0:o.behavior)||(t%2==0?"cautious":"curious"),blinkFrequency:(null==o?void 0:o.blinkFrequency)||(t%2==0?"frequent":"rare"),lastBlink:0}}),h={activeEyePositions:n,eyePairs:g,lastEyePositionChange:l.current,eyeFadeTimestamp:s},m=s+D(4e3,1e4);console.log("[DEBUG] Setting next mammal eyes appearance delay: ".concat(((m-s)/1e3).toFixed(1),"s")),v(e=>{let t={...e,nextMammalEyes:m};return setTimeout(()=>{d.current=t},0),t}),f.current=Date.now(),console.log("[DEBUG] Particle update with delayNextCycle=".concat(p.current,", delay=").concat(h.nextEyeReturnDelay||0)),y(e=>{let t={...e,...h};return setTimeout(()=>{u.current=t},0),t}),console.log("[DEBUG] New mammal eyes created with starting opacity 0.01 for proper fade-in")}else if(c>9.5){if(p.current&&(!F.nextEyeReturnDelay||0===F.nextEyeReturnDelay)){let e=s+D(4e3,1e4);console.log("[DEBUG] Setting delayed random delay of ".concat(((e-s)/1e3).toFixed(1),"s before new eyes appear")),p.current=!1,y(t=>({...t,nextEyeReturnDelay:e}))}if(l.current%100==0){let e=F.nextEyeReturnDelay?((F.nextEyeReturnDelay-s)/1e3).toFixed(1):"unknown";console.log("[DEBUG] Eyes faded out, waiting ".concat(e,"s before new positions"))}}m.forEach((t,i)=>{var o;let a=(null===(o=F.eyePairs)||void 0===o?void 0:o[i])||{opacity:.01,blinkTimer:3e3*Math.random(),size:.64+.32*Math.random(),behavior:i%2==0?"cautious":"curious",blinkFrequency:i%2==0?"frequent":"rare",lastBlink:0,height:t.y},r=a.behavior||"cautious",u=a.blinkFrequency||"frequent",m="frequent"===u?2:1,f=a.blinkTimer-16*A*m,p=a.opacity,b=!0,P=0;f<=0&&!g&&!h&&p>.4&&("cautious"!==r||a.lastBlink?"cautious"===r&&1===a.lastBlink?(f=100,a.lastBlink=2):"cautious"===r&&2===a.lastBlink?(f=2500+2e3*Math.random(),a.lastBlink=0):(f="curious"===r?1800+2500*Math.random():1200+1500*Math.random(),"curious"===r&&.3>Math.random()&&(f=180+150*Math.random())):(f=120,a.lastBlink=1),.2>Math.random()&&console.log("[DEBUG] Eye blink - pair ".concat(i," (").concat(r,"), blink pattern: ").concat(u)));let x=.8+.15*Math.random();if("curious"===r?x*=1.1:x*=.95,g){let e=c/1.5,t=e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2;x*=t,b=!0,P=0,0===i&&l.current%100==0&&console.log("[DEBUG] Eye fade IN - progress: ".concat((100*t).toFixed(0),"%, opacity: ").concat(x.toFixed(2)))}else if(h){let e=(c-7.5)/2,t=1-(e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2);if(x*=t,t<.1&&s>=(G.nextMammalEyes||0)){let e=s+D(4e3,1e4);console.log("[DEBUG] Eyes almost completely faded out. Setting next appearance delay of ".concat(((e-s)/1e3).toFixed(1),"s")),v(t=>{let i={...t,nextMammalEyes:e};return setTimeout(()=>{d.current=i},0),i})}.05>Math.random()&&console.log("[DEBUG] Eye fade OUT - progress: ".concat(Math.round(100*e),"%, opacity: ").concat(p.toFixed(2)))}x=g&&c<.2?0:h&&c>8.8?0:Math.max(.1,x),"cautious"!==r||g||h||(t.x+=.2*Math.sin(s/800+i),t.y+=.1*Math.cos(s/850+i));let w=g||h?.15:"curious"===r?.08:.12;if(p+=(x-p)*w,h)b=(P=Math.min(1,(c-7.5)/1.5*1.5))<.9;else if(f<=200){let e=f<=100?(100-f)/100:(f-100)/100;b=(P="cautious"===r?Math.min(1,1.5*e):Math.min(.9,e))<.9}if(!g&&!h&&p>.5){let e="cautious"===r?800:1200,t="cautious"===r?.15:.08;p*=Math.sin(s/e+i)*t+(1-t)}l.current%10==0&&y(e=>{let t=[...e.eyePairs||[]];return t[i]={...a,opacity:p,blinkTimer:f,behavior:r,blinkFrequency:u},{...e,eyePairs:t}});let S=36*(a.size||1)*.45,M=1.4*S,C=t.x,E=t.y,k=C-M/2,T=C+M/2;if(p>.05){if(n.globalAlpha=.35*e*p,n.fillStyle="rgba(5, 5, 5, 0.8)",n.shadowColor="rgba(0, 0, 0, 0.6)",n.shadowBlur=12,n.beginPath(),n.ellipse(C,E,1.3*M,.8*M,0,0,2*Math.PI),n.fill(),b){let t;n.globalAlpha=.55*e*p,n.fillStyle="rgba(0, 0, 0, 0.95)",n.shadowColor="rgba(0, 0, 0, 0.8)",n.shadowBlur=5;let o=1-.7*P;n.beginPath();let a=1.2*S,s=.9*S*o,l=k+.5*a,c=k-.7*a,u=E-.7*s,d=E+.5*s;n.moveTo(l,E),n.quadraticCurveTo(l-.2*a,u-.1*s,k,u),n.quadraticCurveTo(c+.1*a,u+.2*s,c,E),n.quadraticCurveTo(c+.1*a,d-.1*s,k,d),n.quadraticCurveTo(l-.2*a,d-.1*s,l,E),n.fill(),n.beginPath();let g=T-.5*a,h=T+.7*a,m=E-.7*s,f=E+.5*s;switch(n.moveTo(g,E),n.quadraticCurveTo(g+.2*a,m-.1*s,T,m),n.quadraticCurveTo(h-.1*a,m+.2*s,h,E),n.quadraticCurveTo(h-.1*a,f-.1*s,T,f),n.quadraticCurveTo(g+.2*a,f-.1*s,g,E),n.fill(),n.globalAlpha=.85*e*p*(1-.5*P),"curious"===r?(n.shadowColor="rgba(255, 220, 100, 0.85)",n.shadowBlur=15):(n.shadowColor="rgba(200, 220, 100, 0.75)",n.shadowBlur=12),i%4){case 0:t="curious"===r?"rgba(235, 220, 100, 0.95)":"rgba(225, 210, 100, 0.9)";break;case 1:t="curious"===r?"rgba(220, 240, 120, 0.95)":"rgba(200, 230, 110, 0.9)";break;case 2:t="curious"===r?"rgba(240, 190, 85, 0.95)":"rgba(230, 180, 80, 0.9)";break;case 3:t="curious"===r?"rgba(210, 240, 100, 0.95)":"rgba(200, 230, 90, 0.9)"}if(n.fillStyle=t||"rgba(235, 220, 100, 0.95)",n.beginPath(),n.ellipse(k-.1*a,E,.8*a*.7,.8*s*o*.8,0,0,2*Math.PI),n.fill(),n.beginPath(),n.ellipse(T+.1*a,E,.8*a*.7,.8*s*o*.8,0,0,2*Math.PI),n.fill(),P<.7){n.fillStyle="rgba(255, 255, 255, 1.0)",n.shadowBlur=2;let e=P*S*.1,t="curious"===r?.22*S:.18*S,i=-(.1*S)+e,o=1-.6*P;n.beginPath(),n.arc(k-.1*a+t,E+i,.25*S*o,0,2*Math.PI),n.fill(),n.beginPath(),n.arc(T+.1*a+t,E+i,.25*S*o,0,2*Math.PI),n.fill()}}else{n.globalAlpha=.4*e*p,n.strokeStyle="rgba(20, 20, 20, 0.8)",n.lineWidth=2;let t=1.2*S;n.beginPath(),n.moveTo(k-.7*t,E),n.lineTo(k+.5*t,E),n.stroke();let i=1.2*S;n.beginPath(),n.moveTo(T-.5*i,E),n.lineTo(T+.7*i,E),n.stroke()}}}),n.shadowBlur=0}}if(T.has("birds")&&R.birds>0){let e=R.birds;if(!F.birds||0===F.birds.length){console.log("[DEBUG] Bird particles missing, initializing them now");let e=Array.from({length:8},()=>({x:D(-50,C),y:D(0,.3*E),dx:.8+.7*Math.random(),dy:D(-.3,.3)}));F.birds=e,y(t=>({...t,birds:e})),console.log("[DEBUG] Created ".concat(e.length," new birds"))}n.globalAlpha=.6*e;let t=F.birds.map(e=>{e.x+=e.dx*A,e.y+=e.dy*A*Math.sin(i/1e3+.01*e.x),e.x>C+50&&(e.x=-50),e.x<-50&&(e.x=C+50),e.y>.5*E&&(e.y=.1*E),e.y<0&&(e.y=.3*E),n.fillStyle="rgba(40, 40, 40, 0.8)";let t=Math.sin(i/200+.1*e.x),o=3+3*Math.abs(t),a=e.y-o*(t>0?1:.5),r=e.y-o*(t<0?1:.5);return n.beginPath(),n.arc(e.x,e.y,3,0,2*Math.PI),n.fill(),n.beginPath(),n.moveTo(e.x,e.y),n.lineTo(e.x-8,a),n.lineTo(e.x-2,e.y),n.fill(),n.beginPath(),n.moveTo(e.x,e.y),n.lineTo(e.x+8,r),n.lineTo(e.x+2,e.y),n.fill(),n.beginPath(),n.moveTo(e.x,e.y),n.lineTo(e.x,e.y+5),n.lineTo(e.x+(e.dx>0?4:-4),e.y+3),n.fill(),e});if(Math.random()>.995){if(console.log("[DEBUG] Bird flock changing - Current birds: ".concat(t.length)),Math.random()>.5&&t.length<12){let e=Math.random()>.5;t.push({x:e?-10:C+10,y:D(.05*E,.3*E),dx:e?D(.8,1.5):D(-1.5,-.8),dy:D(-.2,.2)}),console.log("[DEBUG] Added new bird, total: ".concat(t.length))}else t.length>3&&(t.splice(Math.floor(Math.random()*t.length),1),console.log("[DEBUG] Removed bird, total: ".concat(t.length)))}y(e=>({...e,birds:t}))}if(T.has("insects")&&R.insects>0){let e=R.insects;if(!F.fireflies||0===F.fireflies.length){console.log("[DEBUG] Firefly particles missing, initializing them now");let e=Array.from({length:25},()=>({x:D(0,C),y:D(.4*E,.8*E),alpha:0,timer:7e3*Math.random(),pulseInterval:D(2e3,5e3)}));F.fireflies=e,y(t=>({...t,fireflies:e})),console.log("[DEBUG] Created ".concat(e.length," new fireflies"))}let t=F.fireflies.map(t=>{t.timer+=16*A,t.timer>t.pulseInterval&&(t.timer=0);let o=t.timer/t.pulseInterval;if(o<.7?t.alpha=Math.min(1.4*o,1)*e:t.alpha=Math.max(0,1-(o-.7)*3.3)*e,t.x+=.3*Math.sin(i/1e3+.1*t.y)*A,t.y+=(Math.sin(i/1200+.1*t.x)-.2)*.3*A,t.x<0&&(t.x=C),t.x>C&&(t.x=0),t.y<.3*E&&(t.y=.3*E),t.y>.9*E&&(t.y=.9*E),t.alpha>.05){let e=5+2*Math.sin(i/200+t.x),o=n.createRadialGradient(t.x,t.y,0,t.x,t.y,3*e);o.addColorStop(0,"rgba(230, 255, 170, ".concat(t.alpha,")")),o.addColorStop(.4,"rgba(180, 240, 100, ".concat(.6*t.alpha,")")),o.addColorStop(1,"rgba(100, 200, 0, 0)"),n.globalAlpha=.7*t.alpha,n.fillStyle=o,n.beginPath(),n.arc(t.x,t.y,3*e,0,2*Math.PI),n.fill(),n.globalAlpha=t.alpha,n.fillStyle="rgba(230, 255, 200, 1.0)",n.beginPath(),n.arc(t.x,t.y,.6*e,0,2*Math.PI),n.fill()}return t});Math.random()>.995&&(console.log("[DEBUG] Adjusting firefly population"),t.length<Math.floor(15+20*e)&&Math.random()>.5?(t.push({x:D(.1*C,.9*C),y:D(.4*E,.8*E),alpha:0,timer:5e3*Math.random(),pulseInterval:D(2e3,5e3)}),console.log("[DEBUG] Added new firefly, total: ".concat(t.length))):t.length>10&&Math.random()>.7&&(t.splice(Math.floor(Math.random()*t.length),1),console.log("[DEBUG] Removed firefly, total: ".concat(t.length)))),y(e=>({...e,fireflies:t}))}if(T.has("fire")&&R.fire>0){let e=R.fire;u.current.fireLastRendered||(console.log("[DEBUG] Fire effect rendering started, intensity:",e),y(e=>({...e,fireLastRendered:!0}))),l.current%300==0&&console.log("[DEBUG] Fire effect active - intensity:",e,"frame:",l.current),n.globalAlpha=.7*e;let t=n.createRadialGradient(C/2,E-30,0,C/2,E-30,80*e);t.addColorStop(0,"rgba(255, 180, 50, ".concat(.4*e,")")),t.addColorStop(1,"rgba(255, 100, 50, 0)"),n.fillStyle=t,n.beginPath(),n.ellipse(C/2,E-20,80*e,40*e,0,0,2*Math.PI),n.fill();let o=F.embers.map(t=>{t.y-=t.speed*A*e,t.x+=.6*Math.sin(i/400+.1*t.y)*A,t.y<0&&(t.y=E-50+20*Math.random(),t.x=C/2+D(-50,50),t.speed=.5+.8*Math.random(),t.size=2+3*Math.random(),t.color="rgba(".concat(255,", ").concat(100+Math.floor(80*Math.random()),", ").concat(30+Math.floor(40*Math.random()),", ").concat(.7+.3*Math.random(),")")),n.globalAlpha=e;let o=3*t.size,a=n.createRadialGradient(t.x,t.y,0,t.x,t.y,o);return a.addColorStop(0,t.color),a.addColorStop(1,"rgba(255, 100, 0, 0)"),n.fillStyle=a,n.beginPath(),n.arc(t.x,t.y,o,0,2*Math.PI),n.fill(),n.fillStyle=t.color,n.beginPath(),n.arc(t.x,t.y,t.size,0,2*Math.PI),n.fill(),t});y(e=>({...e,embers:o}))}if(T.has("ambient")&&R.ambient>0){let e=R.ambient;n.globalAlpha=.5*e;let t=n.createLinearGradient(0,0,0,E);t.addColorStop(0,"rgba(100, 150, 255, ".concat(.05*e,")")),t.addColorStop(.5,"rgba(150, 200, 255, ".concat(.1*e,")")),t.addColorStop(1,"rgba(100, 150, 255, ".concat(.05*e,")")),n.globalAlpha=.6,n.fillStyle=t,n.fillRect(0,0,C,E),n.globalAlpha=.25*e,n.strokeStyle="rgba(255, 255, 255, 0.8)",F.ambientWaves.forEach((t,o)=>{let a=t.y;n.beginPath(),o%2==0?n.strokeStyle="rgba(220, 240, 255, 0.8)":n.strokeStyle="rgba(255, 240, 255, 0.8)";for(let o=0;o<C;o+=3){let r=a+Math.sin(o*t.speed+i/800+t.offset)*t.amplitude*e;0===o?n.moveTo(o,r):n.lineTo(o,r)}n.stroke()})}if(T.has("spiritual")&&R.spiritual>0){let e=R.spiritual;n.globalAlpha=.6*e,l.current%300==0&&console.log("[DEBUG] Spiritual effect - intensity: ".concat(e));let t=n.createLinearGradient(0,0,0,E);t.addColorStop(0,"rgba(255, 235, 150, ".concat(.12*e,")")),t.addColorStop(.4,"rgba(255, 215, 120, ".concat(.08*e,")")),t.addColorStop(.7,"rgba(245, 200, 100, ".concat(.05*e,")")),t.addColorStop(1,"rgba(230, 190, 80, 0)"),n.globalAlpha=.9*e,n.fillStyle=t,n.fillRect(0,0,C,E);let o=.5*C,a=6+Math.floor(3*e),r=C/(1.5*a);for(let t=0;t<a;t++){let s=t/a*C+r*Math.sin(i/8e3+t),l=n.createLinearGradient(0,0,0,E);l.addColorStop(0,"rgba(255, 235, 140, ".concat(.8*e,")")),l.addColorStop(.3,"rgba(255, 215, 90, ".concat(.5*e,")")),l.addColorStop(.7,"rgba(245, 190, 80, ".concat(.2*e,")")),l.addColorStop(1,"rgba(220, 170, 60, 0)"),n.fillStyle=l,n.globalAlpha=.3*e,n.beginPath(),n.moveTo(s,0),n.lineTo(s+r,0),n.lineTo(o+2*r,E),n.lineTo(o-2*r,E),n.closePath(),n.fill()}i>G.nextPulseRing&&Math.random()<.3*e&&(y(t=>({...t,pulseRings:[...t.pulseRings,{x:o+D(-(.3*C),.3*C),y:E*D(.5,.8),radius:5,alpha:.2*e}]})),v(t=>({...t,nextPulseRing:i+D(3e3,6e3)/e})));let s=F.pulseRings.filter(e=>{if(e.radius+=.5*A,e.alpha-=.003*A,e.alpha<=0)return!1;let t=1-e.y/E,i=e.alpha*(.5+.5*t);return n.globalAlpha=i,n.strokeStyle="rgba(255, 215, 80, 0.7)",n.lineWidth=2,n.beginPath(),n.arc(e.x,e.y,e.radius,0,2*Math.PI),n.stroke(),!0});s.length!==F.pulseRings.length&&y(e=>({...e,pulseRings:s}))}n.globalAlpha=1,r.current=requestAnimationFrame(k)};return r.current=requestAnimationFrame(k),()=>{console.log("[DEBUG] Cleaning up animation effect"),r.current&&(cancelAnimationFrame(r.current),r.current=null),window.removeEventListener("resize",E)}},[]),(0,n.useEffect)(()=>{console.log("[DEBUG] Props changed, updating refs without restarting animation");let e=new Set(h.current),o=new Set(t);t.forEach(t=>{if(!e.has(t)&&(console.log("[DEBUG] New sound activated: ".concat(t)),u.current&&a.current)){let e=a.current;e.width,window.devicePixelRatio,e.height,window.devicePixelRatio,console.log("[DEBUG] Initializing particles for newly activated sound: ".concat(t))}}),h.current=o,Object.keys(i).forEach(e=>{m.current[e]=i[e]})},[t,i]),(0,n.useEffect)(()=>{u.current=b},[b]),(0,n.useEffect)(()=>{d.current=P},[P]),(0,n.useEffect)(()=>{g.current=x},[x]),(0,o.jsx)("canvas",{ref:a,className:"fixed inset-0 pointer-events-none z-10 w-full h-full",id:"visual-effects-canvas"})}let f=[{id:"amazon",name:"Amazon Rainforest",location:"South America",vibe:"Lush, vibrant, and teeming with life",imageUrl:"/assets/images/Amazon.jpg",soundProfile:{wind:.2,rain:.8,birds:.9,thunder:.7,water:.6,insects:.9,mammals:.7,fire:.1,ambient:.8,spiritual:.3}},{id:"black-forest",name:"Black Forest",location:"Germany",vibe:"Mysterious, ancient, and enchanting",imageUrl:"/assets/images/Black.png",soundProfile:{wind:.7,rain:.6,birds:.5,thunder:.4,water:.3,insects:.4,mammals:.6,fire:.2,ambient:.7,spiritual:.8}},{id:"redwood",name:"Redwood Forest",location:"California",vibe:"Majestic, peaceful, and awe-inspiring",imageUrl:"/assets/images/Redwood.png",soundProfile:{wind:.8,rain:.5,birds:.6,thunder:.3,water:.4,insects:.3,mammals:.5,fire:.1,ambient:.6,spiritual:.5}},{id:"boreal",name:"Boreal Forest",location:"Canada",vibe:"Serene, vast, and pristine",imageUrl:"/assets/images/Boreal.png",soundProfile:{wind:.9,rain:.4,birds:.4,thunder:.2,water:.3,insects:.2,mammals:.4,fire:.3,ambient:.5,spiritual:.4}},{id:"taiga",name:"Taiga Forest",location:"Russia",vibe:"Cold, vast, and resilient",imageUrl:"/assets/images/Taiga.png",soundProfile:{wind:.8,rain:.3,birds:.3,thunder:.2,water:.2,insects:.2,mammals:.5,fire:.2,ambient:.4,spiritual:.3}},{id:"sundarbans",name:"Sundarbans",location:"Bangladesh/India",vibe:"Mysterious, wet, and wild",imageUrl:"/assets/images/Sundarbans.png",soundProfile:{wind:.4,rain:.8,birds:.7,thunder:.6,water:.9,insects:.8,mammals:.6,fire:.1,ambient:.7,spiritual:.5}},{id:"aokigahara",name:"Aokigahara",location:"Japan",vibe:"Silent, mysterious, and haunting",imageUrl:"/assets/images/Aokigahara.png",soundProfile:{wind:.3,rain:.5,birds:.2,thunder:.3,water:.2,insects:.3,mammals:.2,fire:.1,ambient:.9,spiritual:.9}},{id:"tongass",name:"Tongass Forest",location:"Alaska",vibe:"Ancient, wet, and wild",imageUrl:"/assets/images/Tongass.png",soundProfile:{wind:.7,rain:.8,birds:.6,thunder:.4,water:.7,insects:.4,mammals:.7,fire:.2,ambient:.6,spiritual:.5}},{id:"jiuzhaigou",name:"Jiuzhaigou Valley",location:"China",vibe:"Colorful, peaceful, and magical",imageUrl:"/assets/images/Jiuzhaigou.png",soundProfile:{wind:.4,rain:.5,birds:.6,thunder:.3,water:.8,insects:.5,mammals:.4,fire:.1,ambient:.7,spiritual:.6}},{id:"crooked",name:"Crooked Forest",location:"Poland",vibe:"Mysterious, unique, and enchanting",imageUrl:"/assets/images/Crooked.png",soundProfile:{wind:.6,rain:.4,birds:.5,thunder:.3,water:.2,insects:.4,mammals:.3,fire:.2,ambient:.6,spiritual:.7}},{id:"drakensberg",name:"Drakensberg Forest",location:"South Africa",vibe:"Dramatic, ancient, and diverse",imageUrl:"/assets/images/Drakensberg.png",soundProfile:{wind:.7,rain:.6,birds:.7,thunder:.5,water:.5,insects:.6,mammals:.5,fire:.3,ambient:.6,spiritual:.6}},{id:"valdivian",name:"Valdivian Forest",location:"Chile",vibe:"Ancient, wet, and mysterious",imageUrl:"/assets/images/Valdivian.png",soundProfile:{wind:.5,rain:.8,birds:.6,thunder:.4,water:.7,insects:.5,mammals:.4,fire:.1,ambient:.7,spiritual:.5}},{id:"sinharaja",name:"Sinharaja Forest",location:"Sri Lanka",vibe:"Lush, diverse, and ancient",imageUrl:"/assets/images/Sinharaja.png",soundProfile:{wind:.3,rain:.8,birds:.8,thunder:.6,water:.6,insects:.8,mammals:.5,fire:.1,ambient:.7,spiritual:.4}},{id:"bialowieza",name:"Białowieża Forest",shortName:"Białowieża",location:"Poland/Belarus",description:"One of the last and largest remaining parts of the immense primeval forest that once stretched across the European Plain. Home to the European bison.",vibe:"ancient, mystical, primeval, dense, wild",imageUrl:"/assets/images/bialowieza_new.jpg",soundProfile:{wind:.4,rain:.3,birds:.6,thunder:.2,water:.3,insects:.4,mammals:.8,fire:0,ambient:.5,spiritual:.3},tags:["temperate","primeval","european","wildlife"]},{id:"hoh",name:"Hoh Forest",location:"Washington, USA",vibe:"temperate, misty, mossy, ancient, peaceful",imageUrl:"/assets/images/Hoh2.png",soundProfile:{wind:.5,rain:.8,birds:.6,thunder:.2,water:.7,insects:.5,mammals:.4,fire:.1,ambient:.6,spiritual:.3}},{id:"daintree",name:"Daintree Forest",location:"Australia",vibe:"Ancient, diverse, and vibrant",imageUrl:"/assets/images/Daintree.jpg",soundProfile:{wind:.4,rain:.7,birds:.8,thunder:.5,water:.5,insects:.8,mammals:.5,fire:.2,ambient:.7,spiritual:.4}},{id:"congo",name:"Congo Rainforest",location:"Central Africa",vibe:"Dense, mysterious, and alive",imageUrl:"/assets/images/Congo.png",soundProfile:{wind:.2,rain:.8,birds:.8,thunder:.6,water:.6,insects:.9,mammals:.8,fire:.1,ambient:.8,spiritual:.4}},{id:"bear",name:"Great Bear Rainforest",location:"Canada",vibe:"Wild, coastal, and pristine",imageUrl:"/assets/images/Bear.jpg",soundProfile:{wind:.7,rain:.8,birds:.6,thunder:.4,water:.7,insects:.4,mammals:.7,fire:.2,ambient:.6,spiritual:.5}},{id:"yakushima",name:"Yakushima Forest",location:"Japan",vibe:"Ancient, mystical, and serene",imageUrl:"/assets/images/Yakushima.jpg",soundProfile:{wind:.5,rain:.8,birds:.5,thunder:.4,water:.6,insects:.4,mammals:.3,fire:.1,ambient:.7,spiritual:.8}}];var p=i(3145);let b={wind:s.W2m,rain:s.JPc,birds:s.BOY,thunder:s.vyv,water:s.TTk,insects:s.Ow4,mammals:s.X_y,fire:s.p8m,ambient:s.tem,spiritual:s.GzN};function y(){let[e,t]=(0,n.useState)(null),[a,r]=(0,n.useState)(new Set),[l,c]=(0,n.useState)({wind:0,rain:0,birds:0,thunder:0,water:0,insects:0,mammals:0,fire:0,ambient:0,spiritual:0}),[g,y]=(0,n.useState)(!1),[P,v]=(0,n.useState)(!1),[x,w]=(0,n.useState)("/assets/images/forest1.png"),[D,S]=(0,n.useState)(!1),[A,M]=(0,n.useState)(!1),[C,E]=(0,n.useState)(!1),k=(0,n.useRef)(null);return(0,n.useEffect)(()=>{(async()=>{console.log("[DEBUG] Starting to preload forest images");let e=f.map(e=>new Promise((t,i)=>{console.log("[DEBUG] Loading image: ".concat(e.name," - ").concat(e.imageUrl));let o=new window.Image,n=setTimeout(()=>{console.error("[ERROR] Timeout loading image: ".concat(e.imageUrl)),i(Error("Timeout loading image: ".concat(e.imageUrl)))},1e4);o.onload=()=>{clearTimeout(n),console.log("[DEBUG] Successfully loaded image: ".concat(e.imageUrl)),t(null)},o.onerror=t=>{clearTimeout(n),console.error("[ERROR] Failed to load image: ".concat(e.imageUrl),t),fetch(e.imageUrl).then(t=>{t.ok||console.error("[ERROR] Image fetch failed with status: ".concat(t.status," for ").concat(e.imageUrl))}).catch(e=>{console.error("[ERROR] Image fetch failed completely: ".concat(e))}),i(t)},o.src=e.imageUrl}));try{await Promise.all(e),console.log("[DEBUG] All forest images preloaded successfully"),v(!0)}catch(e){console.error("[ERROR] Failed to preload images:",e),v(!0)}})()},[]),(0,n.useEffect)(()=>{if(null==e?void 0:e.imageUrl){console.log("[DEBUG] Loading current forest image: ".concat(e.imageUrl));let t=new window.Image;t.onload=()=>{console.log("[DEBUG] Current forest image loaded successfully: ".concat(e.imageUrl)),M(!0),S(!0),setTimeout(()=>{S(!1),w(e.imageUrl)},1e3)},t.onerror=t=>{console.error("[ERROR] Failed to load current forest image: ".concat(e.imageUrl),t),M(!0),S(!0),setTimeout(()=>{S(!1),w(x)},1e3)},t.src=e.imageUrl}},[null==e?void 0:e.imageUrl,x]),(0,o.jsxs)("main",{className:"fixed inset-0 overflow-hidden",children:[(0,o.jsxs)("div",{className:"fixed inset-0 z-0",children:[(0,o.jsx)("div",{className:"absolute inset-0 transition-opacity duration-1000 ease-in-out ".concat(D?"opacity-0":"opacity-100"),children:(0,o.jsx)(p.default,{src:x,alt:"Previous Forest",fill:!0,priority:!0,className:"object-cover",sizes:"100vw",quality:90})}),(0,o.jsx)("div",{className:"absolute inset-0 transition-opacity duration-1000 ease-in-out ".concat(D&&A?"opacity-100":"opacity-0"),children:(0,o.jsx)(p.default,{src:(null==e?void 0:e.imageUrl)||"/assets/images/forest1.png",alt:(null==e?void 0:e.name)||"Default Forest",fill:!0,priority:!0,className:"object-cover",sizes:"100vw",quality:90})})]}),g&&(0,o.jsx)(m,{activeSounds:a,soundValues:l}),(0,o.jsxs)("div",{className:"relative h-full flex flex-col",children:[(0,o.jsxs)("div",{className:"fixed top-4 right-4 z-50 flex flex-row items-center md:hidden",children:[(0,o.jsx)("span",{className:"text-white text-xs bg-black/10 px-3 py-1.5 rounded-l-md whitespace-nowrap",children:"Play in background"}),(0,o.jsx)("button",{onClick:()=>{C?(console.log("Hiding PiP via toggle button - ensuring audio cleanup"),k.current&&(console.log("Calling direct cleanup method via ref"),k.current.cleanupAudio()),E(!1),Promise.resolve().then(i.bind(i,9973)).then(e=>{let{audioManager:t}=e;t&&(console.log("Toggle button: Restoring main page audio via fallback"),t.connectToPiP=void 0,"function"==typeof t.setMainPageMasterGain&&t.setMainPageMasterGain(null),"function"==typeof t.clearPiPConnections&&t.clearPiPConnections())})):E(!0)},className:"bg-black/10 hover:bg-black/20 text-white p-2 rounded-r-md","aria-label":C?"Hide Picture-in-Picture":"Show Picture-in-Picture",title:C?"Hide Picture-in-Picture":"Show Picture-in-Picture",children:C?(0,o.jsx)(s.u52,{size:20}):(0,o.jsx)(s.acF,{size:20})})]}),(0,o.jsx)("div",{className:"flex-none pt-16 md:pt-20 px-4",children:(0,o.jsx)(d,{forest:e})}),(0,o.jsx)("div",{className:"flex-none",children:(0,o.jsx)("div",{className:"w-full py-6",children:(0,o.jsx)(u,{onSoundChange:(i,o)=>{console.log("Page Sound Change:",{activeSounds:i,hasInteracted:g,currentForest:e}),i.includes("fire")?console.log("[DEBUG] Fire sound is included in activeSounds array"):(console.log("[DEBUG] Fire sound is NOT included in activeSounds array"),console.log("[DEBUG] Active sounds:",i)),g||(y(!0),console.log("First interaction detected")),r(new Set(i)),console.log("[DEBUG] After setting activeSounds, size:",i.length);let n={},a={...l};if(o?Object.keys(b).forEach(e=>{let t=o[e]||0;n[e]=t,a[e]=t}):Object.keys(b).forEach(e=>{let t=i.includes(e);n[e]=t?.5:0,a[e]=t?.5:0}),c(a),console.log("Sound Profile:",n),i.length>0){let o=function(e,t){if(0===t.size)return f[0];let i={};t.forEach(t=>{i[t]=e[t]});let o=f.map(e=>{var o;let n,a;return{forest:e,score:(o=e.soundProfile,n=0,a=0,t.forEach(e=>{let t=i[e]||0,r=o[e];n+=(1-Math.abs(t-r))*t,a+=t}),a>0?n/a:0)}});return o.sort((e,t)=>t.score-e.score),o[0].forest}(n,new Set(i));console.log("Matching Forest:",o),o&&(!e||e.id!==o.id)&&(w((null==e?void 0:e.imageUrl)||"/assets/images/forest1.png"),M(!1),S(!1),t(o))}else console.log("No active sounds, clearing forest"),w((null==e?void 0:e.imageUrl)||"/assets/images/forest1.png"),M(!1),S(!1),t(null)}})})}),(0,o.jsx)(h,{ref:k,forest:e,activeSounds:a,isVisible:C,onClose:()=>{console.log("PiP mini player closed by user"),E(!1)}})]})]})}},9973:function(e,t,i){"use strict";i.r(t),i.d(t,{AudioManager:function(){return o},audioManager:function(){return n}});class o{handleIOSForeground(){if(console.log("[Audio Debug] iOS app foregrounded"),this._audioContext&&this.isIOS){console.log("[Audio Debug] Attempting recovery on iOS foreground"),this.wasContextInterrupted=!1;let e=!!this.connectToPiP;this.recoverFromInterruption(),e?console.log("[Audio Debug] PiP active - skipping sound reconnection to avoid duplication"):(console.log("[Audio Debug] Reconnecting all active sounds after foreground"),this.reconnectAllSounds())}}cleanupSound(e){let t=[];this.activeSources.forEach((i,o)=>{(o===e||o.startsWith("".concat(e,"-recovery")))&&t.push(o)}),console.log("[Audio Debug] Cleaning up sound ".concat(e," and ").concat(t.length-1," duplicates")),t.forEach(e=>{try{let t=this.activeSources.get(e),i=this.activeGains.get(e);t&&(t.stop(),this.activeSources.delete(e)),i&&(i.disconnect(),this.activeGains.delete(e))}catch(t){console.error("[Audio Debug] Error cleaning up sound ".concat(e,":"),t)}})}stopSound(e){this.cleanupSound(e)}async playSound(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this.initialized||(console.log("[Audio Debug] Initializing audio context before playing ".concat(e.id)),await this.initialize()),this.cleanupSound(e.id);try{let i=this.audioBuffers.get(e.id);if(!i)return console.log("[Audio Debug] Buffer not found for ".concat(e.id,", loading now")),await this.loadSound(e),this.playSound(e,t);let o=this.getContextState();("suspended"===o||"interrupted"===o)&&(console.log("[Audio Debug] Resuming audio context before playing ".concat(e.id)),await this._audioContext.resume(),"running"!==this.getContextState()&&this.isIOS&&(console.log("[Audio Debug] Audio context still not running (".concat(this.getContextState(),"), attempting recovery")),await this.recoverFromInterruption()));let n=this.wasContextInterrupted?"".concat(e.id,"-recovery-").concat(Date.now()):e.id;console.log("[Audio Debug] Creating source for ".concat(n));let a=this._audioContext.createBufferSource(),r=this._audioContext.createGain();a.buffer=i,a.loop=!0;let s=i.duration;if(console.log("[Audio Debug] ".concat(n," duration: ").concat(s.toFixed(2)," seconds")),s>=10){let e=Math.min(.02,.005*s),t=Math.max(s-.02,.995*s);s>.5&&(a.loopStart=e,a.loopEnd=t,console.log("[Audio Debug] Set loop points for ".concat(n,": ").concat(e.toFixed(3),"s to ").concat(t.toFixed(3),"s")))}r.gain.value=t,console.log("[Audio Debug] Connecting ".concat(n," to output, volume: ").concat(t)),a.connect(r),this._mainPageMasterGain?(console.log("[Audio Debug] Routing ".concat(n," through muted main page output")),r.connect(this._mainPageMasterGain)):r.connect(this._audioContext.destination),this.connectToPiP&&(console.log("[Audio Debug] Connecting ".concat(n," to PiP output")),this.connectToPiP(r)),console.log("[Audio Debug] Starting playback of ".concat(n)),a.start(0),this.activeSources.set(n,a),this.activeGains.set(n,r),a.addEventListener("ended",()=>{console.log("[Audio Debug] Source ended naturally: ".concat(n)),this.activeSources.delete(n),this.activeGains.delete(n),this.wasContextInterrupted&&this.isIOS&&n===e.id&&(console.log("[Audio Debug] Auto-restarting ".concat(e.id," after iOS interruption")),setTimeout(()=>{this.playSound(e,t)},100))})}catch(t){console.error("[Audio Debug] Failed to play sound ".concat(e.id,":"),t)}}reconnectAllSounds(){if(!this._audioContext)return;if(this.connectToPiP){console.log("[Audio Debug] PiP is active during reconnect - using cautious approach");let e=this.getContextState();("suspended"===e||"interrupted"===e)&&(console.log("[Audio Debug] Resuming audio context only due to PiP active"),this._audioContext.resume().catch(e=>{console.error("[Audio Debug] Failed to resume context with PiP active:",e)}));return}let e=new Set,t=new Map;this.activeSources.forEach((i,o)=>{let n=o.includes("-recovery-")?o.split("-recovery-")[0]:o;if(e.add(n),!t.has(n)){let e=this.activeGains.get(o);e&&t.set(n,e.gain.value)}}),e.size>0&&(console.log("[Audio Debug] Reconnecting ".concat(e.size," unique active sounds")),this.stopAllSounds(),e.forEach(e=>{let i=t.get(e)||1;console.log("[Audio Debug] Restarting sound ".concat(e," at volume ").concat(i)),this.playSound({id:e,url:""},i)}))}stopAllSounds(){console.log("[Audio Debug] Stopping all sounds, count: ".concat(this.activeSources.size)),Array.from(this.activeSources.keys()).forEach(e=>{try{let t=this.activeSources.get(e);t&&(console.log("[Audio Debug] Stopping sound: ".concat(e)),t.stop(),this.activeSources.delete(e));let i=this.activeGains.get(e);i&&(i.disconnect(),this.activeGains.delete(e))}catch(t){console.error("[Audio Debug] Failed to stop sound ".concat(e,":"),t)}})}getContextState(){return this._audioContext?this._audioContext.state:"suspended"}async recoverFromInterruption(){if(!this._audioContext)return;console.log("[Audio Debug] Recovering from audio interruption");let e=this.getContextState();console.log("[Audio Debug] Current audio context state before recovery: ".concat(e));try{await this._audioContext.resume(),console.log("[Audio Debug] Resume attempt result: ".concat(this.getContextState()));let e=this.getContextState();if("running"!==e){console.log("[Audio Debug] Audio context not running after resume, recreating context");let e=Array.from(this.activeSources.keys()),t=new Map;if(this.activeGains.forEach((e,i)=>{t.set(i,e.gain.value)}),this.stopAllSounds(),this._audioContext)try{await this._audioContext.close(),console.log("[Audio Debug] Successfully closed old audio context")}catch(e){console.error("[Audio Debug] Error closing audio context:",e)}this._audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("[Audio Debug] Created new audio context after interruption, state: ".concat(this.getContextState())),await this._audioContext.resume(),console.log("[Audio Debug] New context state after resume: ".concat(this.getContextState())),this.startAudioContextMonitoring(),setTimeout(()=>{for(let i of(console.log("[Audio Debug] Restarting sounds after context recreation"),e)){let e={id:i,url:""},o=t.get(i)||1;this.playSound(e,o)}},300)}else this.reconnectAllSounds()}catch(e){console.error("[Audio Debug] Failed to recover from interruption:",e),console.log("[Audio Debug] Attempting last resort recovery");try{this._audioContext=new(window.AudioContext||window.webkitAudioContext),await this._audioContext.resume(),this.startAudioContextMonitoring(),setTimeout(()=>this.reconnectAllSounds(),500)}catch(e){console.error("[Audio Debug] Final recovery attempt failed:",e)}}}handleVisibilityChange(){if("undefined"==typeof document)return;let e=document.visibilityState;if(console.log("[Audio Debug] Document visibility changed: ".concat(this.lastVisibilityState," -> ").concat(e)),"visible"===e&&"hidden"===this.lastVisibilityState&&(console.log("[Audio Debug] Document became visible - checking audio context"),this._audioContext)){let e=this.getContextState();if("suspended"===e||"interrupted"===e){console.log("[Audio Debug] Resuming audio context after visibility change, state: ".concat(e)),this._audioContext.resume().catch(e=>{console.error("[Audio Debug] Failed to resume audio context:",e)});let t=!!this.connectToPiP;this.isIOS&&"interrupted"===e&&(this.recoverFromInterruption(),t?console.log("[Audio Debug] PiP active - skipping sound reconnection to avoid duplication"):(console.log("[Audio Debug] Reconnecting sounds after iOS interruption"),this.reconnectAllSounds()))}}"hidden"===e&&this._audioContext&&(console.log("[Audio Debug] Document hidden, audio context state: ".concat(this.getContextState())),"suspended"===this.getContextState()&&(console.log("[Audio Debug] Resuming suspended audio context due to visibility change"),this._audioContext.resume().catch(e=>{console.error("[Audio Debug] Failed to resume audio context:",e)}))),this.lastVisibilityState=e}get audioContext(){return this._audioContext}static getInstance(){return o.instance||(o.instance=new o),o.instance}async initialize(){if(!this.initialized)try{if(console.log("[Audio Debug] Initializing audio context"),this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("[Audio Debug] Created new audio context, state: ".concat(this.getContextState())),this._audioContext.addEventListener("statechange",()=>{let e=this.getContextState();console.log("[Audio Debug] Audio context state changed: ".concat(e)),"interrupted"===e&&(this.wasContextInterrupted=!0,this.recoveryAttempts=0)})),"suspended"===this.getContextState()&&(console.log("[Audio Debug] Resuming suspended audio context"),await this._audioContext.resume(),console.log("[Audio Debug] Audio context resumed, state: ".concat(this.getContextState()))),"interrupted"===this.getContextState()&&(console.log("[Audio Debug] Handling interrupted audio context"),this.wasContextInterrupted=!0,await this.recoverFromInterruption()),"running"===this.getContextState()){this.initialized=!0,this.startAudioContextMonitoring(),console.log("[Audio Debug] Audio context initialized successfully");return}"closed"===this.getContextState()&&(console.log("[Audio Debug] Audio context closed, creating new one"),this._audioContext=new(window.AudioContext||window.webkitAudioContext)),await this._audioContext.resume(),this.initialized=!0,console.log("[Audio Debug] Audio context successfully initialized"),this.startAudioContextMonitoring()}catch(e){console.error("[Audio Debug] Failed to initialize audio context:",e);try{console.log("[Audio Debug] Attempting recovery by creating a new audio context"),this._audioContext=new(window.AudioContext||window.webkitAudioContext),await this._audioContext.resume(),this.initialized=!0,console.log("[Audio Debug] Successfully recovered audio context"),this.startAudioContextMonitoring()}catch(e){console.error("[Audio Debug] Failed to recover audio context:",e)}}}startAudioContextMonitoring(){this.audioContextStateInterval&&clearInterval(this.audioContextStateInterval);let e=this.isIOS?1e3:2e3;this.audioContextStateInterval=setInterval(()=>{if(!this._audioContext)return;let e=this.getContextState();this.isIOS?(this.recoveryAttempts%5==0&&(console.log("[Audio Debug] iOS periodic check - Audio context state: ".concat(e)),console.log("[Audio Debug] Active sound sources: ".concat(this.activeSources.size))),"running"!==e?(console.log("[Audio Debug] iOS audio context not running (".concat(e,"), attempting recovery")),this.recoveryAttempts<5?(this.recoveryAttempts++,this.recoverFromInterruption()):5===this.recoveryAttempts?(console.log("[Audio Debug] Max recovery attempts reached, will try again later"),this.recoveryAttempts++):this.recoveryAttempts>=10?this.recoveryAttempts=0:this.recoveryAttempts++):(this.recoveryAttempts=0,this.activeSources.size>0&&.03>Math.random()&&(console.log("[Audio Debug] Periodic iOS sound refresh"),this.reconnectAllSounds()))):"undefined"!=typeof document&&"hidden"===document.visibilityState&&(console.log("[Audio Debug] Periodic check - Audio context state: ".concat(e)),console.log("[Audio Debug] Active sound sources: ".concat(this.activeSources.size)),"suspended"===e&&(console.log("[Audio Debug] Auto-resuming suspended audio context"),this._audioContext.resume().catch(e=>{console.error("[Audio Debug] Failed to auto-resume audio context:",e)})))},e)}async loadSound(e){if(this.initialized||await this.initialize(),!this.audioBuffers.has(e.id))try{console.log("[Audio Debug] Loading sound: ".concat(e.id));let t=await fetch(e.url),i=await t.arrayBuffer(),o=this.getContextState();("suspended"===o||"interrupted"===o)&&(console.log("[Audio Debug] Resuming audio context before decoding ".concat(e.id)),await this._audioContext.resume());let n=await this._audioContext.decodeAudioData(i);console.log("[Audio Debug] Loaded ".concat(e.id,": ").concat(n.duration.toFixed(2),"s, ").concat(n.numberOfChannels," channels, ").concat(n.sampleRate,"Hz")),this.audioBuffers.set(e.id,n),console.log("[Audio Debug] Sound loaded: ".concat(e.id))}catch(t){console.error("[Audio Debug] Failed to load sound ".concat(e.id,":"),t)}}setVolume(e,t){let i=this.activeGains.get(e);if(i)try{console.log("[Audio Debug] Setting volume for ".concat(e,": ").concat(t)),i.gain.value=t}catch(t){console.error("[Audio Debug] Failed to set volume for sound ".concat(e,":"),t)}}connectAllToPiP(){if(!this.connectToPiP||!this._audioContext){console.log("[Audio Debug] Cannot connect to PiP - no connection method or context available");return}console.log("[Audio Debug] Connecting all active sources to PiP, count: ".concat(this.activeGains.size));try{let e=this._audioContext.createGain();e.gain.value=0,console.log("[Audio Debug] Created master page gain control (muted)");let t=[];this.activeGains.forEach((i,o)=>{try{if(i.context!==this._audioContext){console.log("[Audio Debug] Skipping ".concat(o," - belongs to different audio context"));return}try{try{i.disconnect(this._audioContext.destination)}catch(e){console.log("[Audio Debug] Node ".concat(o," was not connected to destination"))}i.connect(e),this.connectToPiP&&(console.log("[Audio Debug] Connecting ".concat(o," to PiP")),this.connectToPiP(i),t.push(o))}catch(e){console.error("[Audio Debug] Error connecting ".concat(o,":"),e)}}catch(e){console.error("[Audio Debug] Error reconnecting ".concat(o,":"),e)}}),e.connect(this._audioContext.destination),this._mainPageMasterGain=e,console.log("[Audio Debug] Successfully connected ".concat(t.length," nodes to PiP"))}catch(e){console.error("[Audio Debug] Failed to set up PiP audio routing:",e)}if(this.isIOS){let e=e=>{setTimeout(()=>{this._audioContext&&this.connectToPiP&&(console.log("[Audio Debug] PiP stabilization check at ".concat(e,"ms")),"running"!==this.getContextState()&&(console.log("[Audio Debug] Audio needs recovery during PiP"),this.recoverFromInterruption()),this.activeSources.size>0&&(console.log("[Audio Debug] Refreshing PiP audio connections"),this.activeGains.forEach((e,t)=>{if(e.context!==this._audioContext){console.log("[Audio Debug] Skipping refresh for ".concat(t," - different context"));return}try{this.connectToPiP(e)}catch(e){console.error("[Audio Debug] Error refreshing connection for ".concat(t,":"),e)}})))},e)};e(500),e(1500),e(3e3)}}recoverPiPAudio(){this.isIOS&&(console.log("[Audio Debug] iOS PiP audio recovery triggered"),this._audioContext&&this._audioContext.resume().then(()=>{console.log("[Audio Debug] PiP audio context resumed: ".concat(this.getContextState())),"running"!==this.getContextState()?this.recoverFromInterruption():this.reconnectAllSounds()}).catch(e=>{console.error("[Audio Debug] PiP audio resume failed:",e),this.recoverFromInterruption()}))}cleanup(){console.log("[Audio Debug] Cleaning up AudioManager"),this.stopAllSounds(),this.audioBuffers.clear(),this.activeSources.clear(),this.activeGains.clear(),this.audioContextStateInterval&&(clearInterval(this.audioContextStateInterval),this.audioContextStateInterval=null),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),this.isIOS&&(window.removeEventListener("focus",this.handleIOSForeground.bind(this)),window.removeEventListener("pageshow",this.handleIOSForeground.bind(this)))),this._audioContext&&(console.log("[Audio Debug] Closing audio context"),this._audioContext.close(),this._audioContext=null),this.initialized=!1,this.connectToPiP=void 0,console.log("[Audio Debug] AudioManager cleanup complete")}clearPiPConnections(){console.log("[Audio Debug] Clearing PiP connections"),this.connectToPiP=void 0;let e=new Set,t=new Map;if(this.activeSources.forEach((i,o)=>{let n=o.includes("-recovery-")?o.split("-recovery-")[0]:o;if(e.add(n),!t.has(n)){let e=this.activeGains.get(o);e&&t.set(n,e.gain.value)}}),this._mainPageMasterGain&&this._audioContext){console.log("[Audio Debug] Removing main page mute and restoring direct audio output");try{"running"!==this._audioContext.state&&(console.log("[Audio Debug] Resuming audio context before restoring main page audio"),this._audioContext.resume().catch(e=>{console.error("[Audio Debug] Error resuming context during PiP exit:",e)})),this._mainPageMasterGain.disconnect(),this._mainPageMasterGain=null,console.log("[Audio Debug] Reconnecting all audio nodes directly to main output"),this.activeGains.forEach((e,t)=>{try{e.disconnect(),e.connect(this._audioContext.destination),console.log("[Audio Debug] Restored main page audio for: ".concat(t))}catch(e){console.error("[Audio Debug] Error reconnecting node to main output: ".concat(t),e)}})}catch(e){console.error("[Audio Debug] Error removing main page mute:",e)}}console.log("[Audio Debug] Found ".concat(e.size," unique sounds to restore")),this.stopAllSounds(),e.forEach(e=>{let i=t.get(e)||.3;console.log("[Audio Debug] Restarting ".concat(e," after PiP exit with volume ").concat(i)),this.playSound({id:e,url:""},i)}),this._audioContext&&"running"!==this._audioContext.state&&(console.log("[Audio Debug] Final audio context resume after PiP exit"),this._audioContext.resume().catch(e=>{console.error("[Audio Debug] Final resume error:",e)}))}ensureAllStopped(e){console.log("[Audio Debug] Ensuring all instances of ".concat(e.join(", ")," are completely stopped")),e.forEach(e=>{this.cleanupSound(e)}),Array.from(this.activeSources.keys()).forEach(t=>{if(e.some(e=>t===e||t.startsWith("".concat(e,"-recovery"))||t.includes(e))){console.log("[Audio Debug] Force stopping extra instance: ".concat(t));try{let e=this.activeSources.get(t);e&&(e.stop(),this.activeSources.delete(t));let i=this.activeGains.get(t);i&&(i.disconnect(),this.activeGains.delete(t))}catch(e){console.error("[Audio Debug] Error force stopping: ".concat(t),e)}}})}setMainPageMasterGain(e){if(console.log("[Audio Debug] Setting main page master gain: ".concat(e?"enabled":"disabled")),this._mainPageMasterGain)try{this._mainPageMasterGain.disconnect()}catch(e){console.error("[Audio Debug] Error disconnecting previous master gain:",e)}this._mainPageMasterGain=e,null!==e&&this.activeSources.size>0&&(console.log("[Audio Debug] Reconnecting active sounds to new gain setup"),this.reconnectAllSounds())}dedupAllSounds(){if(!this._audioContext)return;console.log("[Audio Debug] Running deduplication on all active sounds");let e=new Map;this.activeSources.forEach((t,i)=>{let o=i.includes("-recovery-")?i.split("-recovery-")[0]:i;e.has(o)||e.set(o,[]),e.get(o).push(i)}),e.forEach((e,t)=>{if(e.length>1){console.log("[Audio Debug] Found ".concat(e.length," instances of sound ").concat(t)),e.sort((e,t)=>{let i=e.includes("-recovery-")?parseInt(e.split("-recovery-")[1]||"0"):0;return(t.includes("-recovery-")?parseInt(t.split("-recovery-")[1]||"0"):0)-i});let i=e[0];console.log("[Audio Debug] Keeping newest instance: ".concat(i));for(let t=1;t<e.length;t++){let i=e[t];console.log("[Audio Debug] Stopping duplicate: ".concat(i));try{let e=this.activeSources.get(i),t=this.activeGains.get(i);e&&(e.stop(),this.activeSources.delete(i)),t&&(t.disconnect(),this.activeGains.delete(i))}catch(e){console.error("[Audio Debug] Error stopping duplicate: ".concat(i),e)}}}})}constructor(){this._audioContext=null,this.audioBuffers=new Map,this.activeSources=new Map,this.activeGains=new Map,this.initialized=!1,this.audioContextStateInterval=null,this.lastVisibilityState="visible",this.recoveryAttempts=0,this.isIOS=!1,this.wasContextInterrupted=!1,this._mainPageMasterGain=null,"undefined"!=typeof navigator&&(this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1),"undefined"!=typeof document&&(document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),this.lastVisibilityState=document.visibilityState,this.isIOS&&(window.addEventListener("focus",this.handleIOSForeground.bind(this)),window.addEventListener("pageshow",this.handleIOSForeground.bind(this))))}}let n=o.getInstance()}},function(e){e.O(0,[950,292,971,117,744],function(){return e(e.s=3844)}),_N_E=e.O()}]);